<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sandro Sandri</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Arapey:ital@0;1&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pages.css">
    <style>
        .admin-dashboard {
            padding: calc(var(--nav-height) + var(--space-lg)) var(--space-md) var(--space-xl);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-header {
            margin-bottom: var(--space-xl);
        }
        
        .admin-title {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            color: var(--color-navy);
            margin-bottom: var(--space-sm);
        }
        
        .admin-subtitle {
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--color-text-light);
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        
        .admin-stat-card {
            background: var(--color-white);
            padding: var(--space-md);
            border: 1px solid var(--color-gray);
            border-radius: 4px;
        }
        
        .admin-stat-label {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: var(--space-xs);
        }
        
        .admin-stat-value {
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--color-navy);
        }
        
        .admin-actions {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }
        
        .admin-action-btn {
            padding: var(--space-sm) var(--space-lg);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .admin-action-btn-primary {
            background: var(--color-navy);
            color: var(--color-white);
        }
        
        .admin-action-btn-primary:hover {
            background: var(--color-navy-dark);
        }
        
        .admin-action-btn-secondary {
            background: var(--color-white);
            color: var(--color-navy);
            border: 1px solid var(--color-navy);
        }
        
        .admin-action-btn-secondary:hover {
            background: var(--color-gray-light);
        }
        
        .admin-section {
            background: var(--color-white);
            padding: var(--space-lg);
            border: 1px solid var(--color-gray);
            border-radius: 4px;
            margin-bottom: var(--space-lg);
        }
        
        .admin-section-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            color: var(--color-navy);
            margin-bottom: var(--space-md);
        }
        
        .admin-draft-list {
            list-style: none;
            padding: 0;
        }
        
        .admin-draft-item {
            padding: var(--space-sm);
            border-bottom: 1px solid var(--color-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-draft-item:last-child {
            border-bottom: none;
        }
        
        .admin-draft-info {
            flex: 1;
        }
        
        .admin-draft-key {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text);
        }
        
        .admin-draft-preview {
            font-family: var(--font-sans);
            font-size: 0.75rem;
            color: var(--color-text-light);
            margin-top: var(--space-xs);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav scrolled">
        <a href="index.html" class="nav-logo">Sandro Sandri</a>
        <div class="nav-right">
            <a href="index.html" class="nav-link">View Website</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="admin-dashboard">
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <p class="admin-subtitle">Manage your website content and view analytics</p>
        </div>

        <div class="admin-stats">
            <div class="admin-stat-card">
                <div class="admin-stat-label">Online Users</div>
                <div class="admin-stat-value" id="dashboard-online-count">0</div>
                <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: var(--space-xs);">
                    Active users on website
                </div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-label">Users on Checkout</div>
                <div class="admin-stat-value" id="dashboard-checkout-count">0</div>
                <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: var(--space-xs);">
                    Active purchase intent
                </div>
            </div>
        </div>

        <div class="admin-actions">
            <button class="admin-action-btn admin-action-btn-secondary" id="reset-inventory-btn" style="background: #4caf50; color: white;">Reset Inventory to Full Stock</button>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Size Selection Statistics</h2>
            <div id="size-stats-table-container" style="overflow-x: auto; margin-bottom: var(--space-lg);">
                <table id="size-stats-table" style="width: 100%; border-collapse: collapse; margin-top: var(--space-md);">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">Size</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">Total Customers</th>
                        </tr>
                    </thead>
                    <tbody id="size-stats-tbody">
                        <tr>
                            <td colspan="2" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">No size selections tracked yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h3 class="admin-section-title" style="font-size: 1.25rem; margin-top: var(--space-lg);">Size Selection by Country</h3>
            <div id="size-tracking-table-container" style="overflow-x: auto;">
                <table id="size-tracking-table" style="width: 100%; border-collapse: collapse; margin-top: var(--space-md);">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">Country</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">XS</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">S</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">M</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">L</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">XL</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-size: 0.875rem; font-weight: 600;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="size-tracking-tbody">
                        <tr>
                            <td colspan="7" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">No size selections tracked yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Customer Information</h2>
            <div style="margin-bottom: var(--space-md);">
                <button class="admin-action-btn admin-action-btn-primary" id="load-customers-btn">Load All Customers</button>
                <button class="admin-action-btn admin-action-btn-secondary" id="export-customers-btn" style="display: none;">Export to CSV</button>
            </div>
            <div id="customers-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading customer data...
            </div>
            <div id="customers-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="customers-summary" style="display: none; margin-bottom: var(--space-md); padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                <strong>Total Customers:</strong> <span id="total-customers-count">0</span>
            </div>
            <div id="customers-table-container" style="overflow-x: auto; display: none;">
                <table id="customers-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-gray-light); z-index: 10;">Email</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Name</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Password</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Last Login</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Total Orders</th>
                            <th style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray); font-weight: 600;">Total Spent</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Last Order</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Sizes</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Chapters</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Favorites</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Address</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Payment Methods</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Quick Links</h2>
            <div class="admin-actions">
                <a href="index.html" class="admin-action-btn admin-action-btn-secondary">Home Page</a>
                <a href="collection.html" class="admin-action-btn admin-action-btn-secondary">Collection</a>
                <a href="product.html" class="admin-action-btn admin-action-btn-secondary">Product Page</a>
            </div>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/activity-tracker.js"></script>
    <script src="js/admin.js"></script>
    <script>
        // Check authentication
        if (!window.auth || !window.auth.isOwner()) {
            window.location.href = 'login.html';
        }
        
        // Initialize dashboard
        function updateDashboard() {
            // Update online users
            if (window.AdminSystem) {
                const onlineCount = window.AdminSystem.onlineUsers || 0;
                document.getElementById('dashboard-online-count').textContent = onlineCount;
            }
        }
        
        // Bind reset inventory button
        document.getElementById('reset-inventory-btn').addEventListener('click', () => {
            if (confirm('Reset all inventory to full stock? This will restore all sizes to their maximum quantities (XS: 10, S: 20, M: 50, L: 50, XL: 20 per model).')) {
                if (window.InventoryAPI && window.InventoryAPI.reset) {
                    window.InventoryAPI.reset();
                    alert('Inventory reset successfully! All products now have full stock.');
                    // Reload to see changes
                    window.location.reload();
                } else {
                    alert('Inventory API not available. Please refresh the page.');
                }
            }
        });
        
        // Country code to name mapping
        function getCountryName(code) {
            const countryMap = {
                'AF': 'Afghanistan', 'AX': 'Åland Islands', 'AL': 'Albania', 'DZ': 'Algeria',
                'AS': 'American Samoa', 'AD': 'Andorra', 'AO': 'Angola', 'AI': 'Anguilla',
                'AQ': 'Antarctica', 'AG': 'Antigua and Barbuda', 'AR': 'Argentina', 'AM': 'Armenia',
                'AW': 'Aruba', 'AU': 'Australia', 'AT': 'Austria', 'AZ': 'Azerbaijan',
                'BS': 'Bahamas', 'BH': 'Bahrain', 'BD': 'Bangladesh', 'BB': 'Barbados',
                'BY': 'Belarus', 'BE': 'Belgium', 'BZ': 'Belize', 'BJ': 'Benin',
                'BM': 'Bermuda', 'BT': 'Bhutan', 'BO': 'Bolivia', 'BQ': 'Bonaire, Sint Eustatius and Saba',
                'BA': 'Bosnia and Herzegovina', 'BW': 'Botswana', 'BV': 'Bouvet Island', 'BR': 'Brazil',
                'IO': 'British Indian Ocean Territory', 'BN': 'Brunei Darussalam', 'BG': 'Bulgaria',
                'BF': 'Burkina Faso', 'BI': 'Burundi', 'CV': 'Cabo Verde', 'KH': 'Cambodia',
                'CM': 'Cameroon', 'CA': 'Canada', 'KY': 'Cayman Islands', 'CF': 'Central African Republic',
                'TD': 'Chad', 'CL': 'Chile', 'CN': 'China', 'CX': 'Christmas Island',
                'CC': 'Cocos (Keeling) Islands', 'CO': 'Colombia', 'KM': 'Comoros', 'CG': 'Congo',
                'CD': 'Congo, Democratic Republic of the', 'CK': 'Cook Islands', 'CR': 'Costa Rica',
                'CI': 'Côte d\'Ivoire', 'HR': 'Croatia', 'CU': 'Cuba', 'CW': 'Curaçao',
                'CY': 'Cyprus', 'CZ': 'Czechia', 'DK': 'Denmark', 'DJ': 'Djibouti',
                'DM': 'Dominica', 'DO': 'Dominican Republic', 'EC': 'Ecuador', 'EG': 'Egypt',
                'SV': 'El Salvador', 'GQ': 'Equatorial Guinea', 'ER': 'Eritrea', 'EE': 'Estonia',
                'SZ': 'Eswatini', 'ET': 'Ethiopia', 'FK': 'Falkland Islands (Malvinas)', 'FO': 'Faroe Islands',
                'FJ': 'Fiji', 'FI': 'Finland', 'FR': 'France', 'GF': 'French Guiana',
                'PF': 'French Polynesia', 'TF': 'French Southern Territories', 'GA': 'Gabon', 'GM': 'Gambia',
                'GE': 'Georgia', 'DE': 'Germany', 'GH': 'Ghana', 'GI': 'Gibraltar',
                'GR': 'Greece', 'GL': 'Greenland', 'GD': 'Grenada', 'GP': 'Guadeloupe',
                'GU': 'Guam', 'GT': 'Guatemala', 'GG': 'Guernsey', 'GN': 'Guinea',
                'GW': 'Guinea-Bissau', 'GY': 'Guyana', 'HT': 'Haiti', 'HM': 'Heard Island and McDonald Islands',
                'VA': 'Holy See', 'HN': 'Honduras', 'HK': 'Hong Kong', 'HU': 'Hungary',
                'IS': 'Iceland', 'IN': 'India', 'ID': 'Indonesia', 'IR': 'Iran (Islamic Republic of)',
                'IQ': 'Iraq', 'IE': 'Ireland', 'IM': 'Isle of Man', 'IL': 'Israel',
                'IT': 'Italy', 'JM': 'Jamaica', 'JP': 'Japan', 'JE': 'Jersey',
                'JO': 'Jordan', 'KZ': 'Kazakhstan', 'KE': 'Kenya', 'KI': 'Kiribati',
                'KP': 'Korea (Democratic People\'s Republic of)', 'KR': 'Korea, Republic of', 'KW': 'Kuwait',
                'KG': 'Kyrgyzstan', 'LA': 'Lao People\'s Democratic Republic', 'LV': 'Latvia', 'LB': 'Lebanon',
                'LS': 'Lesotho', 'LR': 'Liberia', 'LY': 'Libya', 'LI': 'Liechtenstein',
                'LT': 'Lithuania', 'LU': 'Luxembourg', 'MO': 'Macao', 'MG': 'Madagascar',
                'MW': 'Malawi', 'MY': 'Malaysia', 'MV': 'Maldives', 'ML': 'Mali',
                'MT': 'Malta', 'MH': 'Marshall Islands', 'MQ': 'Martinique', 'MR': 'Mauritania',
                'MU': 'Mauritius', 'YT': 'Mayotte', 'MX': 'Mexico', 'FM': 'Micronesia (Federated States of)',
                'MD': 'Moldova, Republic of', 'MC': 'Monaco', 'MN': 'Mongolia', 'ME': 'Montenegro',
                'MS': 'Montserrat', 'MA': 'Morocco', 'MZ': 'Mozambique', 'MM': 'Myanmar',
                'NA': 'Namibia', 'NR': 'Nauru', 'NP': 'Nepal', 'NL': 'Netherlands',
                'NC': 'New Caledonia', 'NZ': 'New Zealand', 'NI': 'Nicaragua', 'NE': 'Niger',
                'NG': 'Nigeria', 'NU': 'Niue', 'NF': 'Norfolk Island', 'MK': 'North Macedonia',
                'MP': 'Northern Mariana Islands', 'NO': 'Norway', 'OM': 'Oman', 'PK': 'Pakistan',
                'PW': 'Palau', 'PS': 'Palestine, State of', 'PA': 'Panama', 'PG': 'Papua New Guinea',
                'PY': 'Paraguay', 'PE': 'Peru', 'PH': 'Philippines', 'PN': 'Pitcairn',
                'PL': 'Poland', 'PT': 'Portugal', 'PR': 'Puerto Rico', 'QA': 'Qatar',
                'RE': 'Réunion', 'RO': 'Romania', 'RU': 'Russian Federation', 'RW': 'Rwanda',
                'BL': 'Saint Barthélemy', 'SH': 'Saint Helena, Ascension and Tristan da Cunha',
                'KN': 'Saint Kitts and Nevis', 'LC': 'Saint Lucia', 'MF': 'Saint Martin (French part)',
                'PM': 'Saint Pierre and Miquelon', 'VC': 'Saint Vincent and the Grenadines', 'WS': 'Samoa',
                'SM': 'San Marino', 'ST': 'Sao Tome and Principe', 'SA': 'Saudi Arabia', 'SN': 'Senegal',
                'RS': 'Serbia', 'SC': 'Seychelles', 'SL': 'Sierra Leone', 'SG': 'Singapore',
                'SX': 'Sint Maarten (Dutch part)', 'SK': 'Slovakia', 'SI': 'Slovenia', 'SB': 'Solomon Islands',
                'SO': 'Somalia', 'ZA': 'South Africa', 'GS': 'South Georgia and the South Sandwich Islands',
                'SS': 'South Sudan', 'ES': 'Spain', 'LK': 'Sri Lanka', 'SD': 'Sudan',
                'SR': 'Suriname', 'SJ': 'Svalbard and Jan Mayen', 'SE': 'Sweden', 'CH': 'Switzerland',
                'SY': 'Syrian Arab Republic', 'TW': 'Taiwan, Province of China', 'TJ': 'Tajikistan',
                'TZ': 'Tanzania, United Republic of', 'TH': 'Thailand', 'TL': 'Timor-Leste', 'TG': 'Togo',
                'TK': 'Tokelau', 'TO': 'Tonga', 'TT': 'Trinidad and Tobago', 'TN': 'Tunisia',
                'TR': 'Turkey', 'TM': 'Turkmenistan', 'TC': 'Turks and Caicos Islands', 'TV': 'Tuvalu',
                'UG': 'Uganda', 'UA': 'Ukraine', 'AE': 'United Arab Emirates', 'GB': 'United Kingdom',
                'UM': 'United States Minor Outlying Islands', 'US': 'United States', 'UY': 'Uruguay',
                'UZ': 'Uzbekistan', 'VU': 'Vanuatu', 'VE': 'Venezuela', 'VN': 'Viet Nam',
                'VG': 'Virgin Islands, British', 'VI': 'Virgin Islands, U.S.', 'WF': 'Wallis and Futuna',
                'EH': 'Western Sahara', 'YE': 'Yemen', 'ZM': 'Zambia', 'ZW': 'Zimbabwe'
            };
            return countryMap[code] || code;
        }
        
        // Update size tracking tables
        function updateSizeTracking() {
            try {
                const trackingData = localStorage.getItem('sandroSandriSizeTracking');
                console.log('Admin: Reading size tracking data:', trackingData);
                const tracking = trackingData ? JSON.parse(trackingData) : {};
                console.log('Admin: Parsed tracking data:', tracking);
            
            // Calculate total by size
            const sizeTotals = { XS: 0, S: 0, M: 0, L: 0, XL: 0 };
            Object.keys(tracking).forEach(country => {
                const countryData = tracking[country];
                Object.keys(sizeTotals).forEach(size => {
                    sizeTotals[size] += countryData[size] || 0;
                });
            });
            
            // Update size statistics table
            const statsTbody = document.getElementById('size-stats-tbody');
            const totalCustomers = Object.values(sizeTotals).reduce((sum, val) => sum + val, 0);
            
            if (totalCustomers === 0) {
                statsTbody.innerHTML = `
                    <tr>
                        <td colspan="2" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">No size selections tracked yet</td>
                    </tr>
                `;
            } else {
                statsTbody.innerHTML = `
                    <tr style="background: var(--color-white);">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-family: var(--font-sans); font-weight: 600;">XS</td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${sizeTotals.XS}</td>
                    </tr>
                    <tr style="background: var(--color-gray-light);">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-family: var(--font-sans); font-weight: 600;">S</td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${sizeTotals.S}</td>
                    </tr>
                    <tr style="background: var(--color-white);">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-family: var(--font-sans); font-weight: 600;">M</td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${sizeTotals.M}</td>
                    </tr>
                    <tr style="background: var(--color-gray-light);">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-family: var(--font-sans); font-weight: 600;">L</td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${sizeTotals.L}</td>
                    </tr>
                    <tr style="background: var(--color-white);">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-family: var(--font-sans); font-weight: 600;">XL</td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${sizeTotals.XL}</td>
                    </tr>
                `;
            }
            
            // Update country breakdown table
            const trackingTbody = document.getElementById('size-tracking-tbody');
            const countries = Object.keys(tracking).sort();
            
            if (countries.length === 0) {
                trackingTbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">No size selections tracked yet</td>
                    </tr>
                `;
            } else {
                let html = '';
                countries.forEach(country => {
                    const countryData = tracking[country];
                    const total = (countryData.XS || 0) + (countryData.S || 0) + (countryData.M || 0) + (countryData.L || 0) + (countryData.XL || 0);
                    
                    // Get country name from country code
                    const countryName = getCountryName(country);
                    
                    html += `
                        <tr>
                            <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-family: var(--font-sans);">${countryName}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${countryData.XS || 0}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${countryData.S || 0}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${countryData.M || 0}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${countryData.L || 0}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans);">${countryData.XL || 0}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-family: var(--font-sans); font-weight: 600;">${total}</td>
                        </tr>
                    `;
                });
                trackingTbody.innerHTML = html;
            }
            } catch (error) {
                console.error('Error updating size tracking:', error);
            }
        }
        
        // Update dashboard every 2 seconds for real-time updates
        setInterval(() => {
            updateDashboard();
            updateSizeTracking();
        }, 2000);
        updateDashboard();
        updateSizeTracking();
        
        // Listen for storage events to update immediately when size is selected (cross-tab)
        window.addEventListener('storage', (e) => {
            if (e.key === 'sandroSandriSizeTracking') {
                console.log('Admin: Storage event detected, updating size tracking');
                updateSizeTracking();
            }
        });
        
        // Also listen for custom events (for same-tab updates)
        // Since storage events only fire in other tabs, we need a custom event for same-tab updates
        window.addEventListener('sizeTrackingUpdated', () => {
            console.log('Admin: Custom event detected, updating size tracking');
            updateSizeTracking();
        });
        
        // Poll localStorage periodically as a fallback
        let lastTrackingData = null;
        setInterval(() => {
            const currentData = localStorage.getItem('sandroSandriSizeTracking');
            if (currentData !== lastTrackingData) {
                console.log('Admin: Tracking data changed, updating');
                lastTrackingData = currentData;
                updateSizeTracking();
            }
        }, 1000);

        // Customer Information Management
        let allCustomersData = null;

        async function loadCustomers() {
            const loadingEl = document.getElementById('customers-loading');
            const errorEl = document.getElementById('customers-error');
            const tableContainer = document.getElementById('customers-table-container');
            const summaryEl = document.getElementById('customers-summary');
            const tbody = document.getElementById('customers-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';
            summaryEl.style.display = 'none';

            try {
                const response = await fetch('/api/admin/customers');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to load customers');
                }

                allCustomersData = data.customers;
                
                // Update summary
                document.getElementById('total-customers-count').textContent = data.totalCustomers;
                summaryEl.style.display = 'block';
                
                // Render table
                renderCustomersTable(allCustomersData);
                tableContainer.style.display = 'block';
                document.getElementById('export-customers-btn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error loading customers:', error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customers-tbody');
            
            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">
                            No customers found
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate totals across all customers
            const grandTotalOrders = customers.reduce((sum, c) => sum + (c.totalOrders || 0), 0);
            const grandTotalSpent = customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0);
            const grandTotalFavorites = customers.reduce((sum, c) => sum + (c.favorites?.length || 0), 0);

            let html = '';
            customers.forEach((customer, index) => {
                const name = customer.profile?.name || customer.email.split('@')[0];
                const password = customer.password || 'Not set';
                const lastLogin = customer.lastLogin 
                    ? new Date(customer.lastLogin).toLocaleString()
                    : 'Never';
                const lastOrderDate = customer.lastOrderDate 
                    ? new Date(customer.lastOrderDate).toLocaleDateString()
                    : 'Never';
                
                // Get all sizes from profile and orders
                const allSizes = new Set();
                
                // First, check the customer's profile size (their selected size preference)
                if (customer.profile && customer.profile.size) {
                    allSizes.add(customer.profile.size);
                }
                
                // Then, get sizes from all orders
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => allSizes.add(size));
                    } else if (order.cart) {
                        order.cart.forEach(item => {
                            if (item.size) allSizes.add(item.size);
                        });
                    }
                });
                const sizesList = Array.from(allSizes).sort().join(', ') || 'None';
                
                // Get all chapters purchased
                const allChapters = new Set();
                customer.orders.forEach(order => {
                    if (order.chaptersPurchased && Array.isArray(order.chaptersPurchased)) {
                        order.chaptersPurchased.forEach(chapter => allChapters.add(chapter));
                    }
                });
                const chaptersList = Array.from(allChapters).join(', ') || 'None';
                
                // Get unique payment methods
                const paymentMethods = new Set();
                customer.orders.forEach(order => {
                    if (order.paymentMethod) {
                        if (order.paymentMethod.card) {
                            const cardInfo = `${order.paymentMethod.card.brand.toUpperCase()} •••• ${order.paymentMethod.card.last4}`;
                            paymentMethods.add(cardInfo);
                        }
                    }
                });
                const paymentMethodsList = Array.from(paymentMethods).join(', ') || 'None';
                
                // Get address from profile first, then from most recent order
                let customerAddress = 'None';
                if (customer.profile && customer.profile.address) {
                    // Profile address is stored as a single string
                    customerAddress = customer.profile.address;
                } else if (customer.orders && customer.orders.length > 0) {
                    // Fall back to most recent order address
                    const sortedOrders = [...customer.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const latestOrder = sortedOrders[0];
                    if (latestOrder.shippingAddress) {
                        const addr = latestOrder.shippingAddress;
                        customerAddress = `${addr.street || ''}${addr.apartment ? ', ' + addr.apartment : ''}, ${addr.city || ''} ${addr.postalCode || ''}, ${addr.country || latestOrder.shippingCountry || ''}`.trim();
                        if (customerAddress.endsWith(',')) {
                            customerAddress = customerAddress.slice(0, -1);
                        }
                    } else if (latestOrder.shippingCountry) {
                        customerAddress = latestOrder.shippingCountry;
                    }
                }

                const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                
                html += `
                    <tr ${rowClass} data-email="${customer.email}">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); position: sticky; left: 0; background: inherit; font-weight: 500;">
                            ${customer.email}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray);">
                            ${name}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; font-family: monospace;">
                            ${password}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${lastLogin}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${customer.totalOrders}
                        </td>
                        <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">
                            €${customer.totalSpent.toFixed(2)}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${lastOrderDate}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${sizesList}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${chaptersList}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${customer.favorites.length}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; max-width: 200px;">
                            ${customerAddress}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; max-width: 150px;">
                            ${paymentMethodsList || 'None'}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <button class="view-customer-details" data-email="${customer.email}" style="padding: 4px 8px; font-size: 0.75rem; background: var(--color-navy); color: white; border: none; cursor: pointer; border-radius: 2px;">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            // Add total row at the end
            html += `
                <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                    <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">
                        <strong>GRAND TOTAL:</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${customers.length}</strong>
                    </td>
                    <td colspan="2" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${grandTotalOrders}</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">
                        <strong>€${grandTotalSpent.toFixed(2)}</strong>
                    </td>
                    <td colspan="3" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${grandTotalFavorites}</strong>
                    </td>
                    <td style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td colspan="2" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                </tr>
            `;
            
            tbody.innerHTML = html;

            // Add click handlers for view details
            document.querySelectorAll('.view-customer-details').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    showCustomerDetails(email);
                });
            });
        }

        function showCustomerDetails(email) {
            const customer = allCustomersData.find(c => c.email === email);
            if (!customer) return;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: var(--space-lg);';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: var(--space-xl); border-radius: 4px; position: relative;';
            
            // Get address from profile first, then from most recent order
            let latestAddress = null;
            if (customer.profile && customer.profile.address) {
                // Profile address is stored as a string, convert to object format for display
                latestAddress = {
                    street: customer.profile.address,
                    city: customer.profile.city || '',
                    postalCode: customer.profile.postalCode || '',
                    country: customer.profile.country || ''
                };
            } else if (customer.orders.length > 0) {
                const sortedOrders = [...customer.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                latestAddress = sortedOrders[0].shippingAddress;
            }
            
            let ordersHtml = '';
            customer.orders.forEach((order, index) => {
                const orderDate = new Date(order.createdAt).toLocaleString();
                const paymentInfo = order.paymentMethod?.card 
                    ? `${order.paymentMethod.card.brand.toUpperCase()} •••• ${order.paymentMethod.card.last4} (Exp: ${order.paymentMethod.card.exp_month}/${order.paymentMethod.card.exp_year})`
                    : 'N/A';
                
                const address = order.shippingAddress || {};
                const addressStr = address.street 
                    ? `${address.street}${address.apartment ? ', ' + address.apartment : ''}, ${address.city}, ${address.postalCode}, ${address.country || order.shippingCountry || 'N/A'}`
                    : (order.shippingCountry || 'N/A');
                
                ordersHtml += `
                    <div style="border: 1px solid var(--color-gray); padding: var(--space-md); margin-bottom: var(--space-md); border-radius: 4px;">
                        <h4 style="margin-bottom: var(--space-sm);">Order #${order.order_number || order.id}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); font-size: 0.875rem; margin-bottom: var(--space-sm);">
                            <div><strong>Order ID:</strong> ${order.order_id || order.id}</div>
                            <div><strong>User ID:</strong> ${order.user_id || customer.email}</div>
                            <div><strong>Order Number:</strong> ${order.order_number || order.id}</div>
                            <div><strong>Status:</strong> ${order.status}</div>
                            <div><strong>Date:</strong> ${orderDate}</div>
                            <div><strong>Currency:</strong> ${order.currency || 'EUR'}</div>
                            <div><strong>Subtotal:</strong> €${(order.subtotal || 0).toFixed(2)}</div>
                            <div><strong>Shipping Cost:</strong> €${(order.shipping_cost || order.shipping || 0).toFixed(2)}</div>
                            <div><strong>Tax:</strong> €${(order.tax || 0).toFixed(2)}</div>
                            <div><strong>Total:</strong> €${(order.total || 0).toFixed(2)}</div>
                            <div><strong>Payment Method:</strong> ${paymentInfo}</div>
                            <div><strong>Stripe Session:</strong> ${order.stripeSessionId || 'N/A'}</div>
                        </div>
                        <div style="margin-top: var(--space-sm); margin-bottom: var(--space-sm);">
                            <strong>Shipping Address:</strong>
                            <div style="font-size: 0.875rem; margin-top: var(--space-xs); padding: var(--space-xs); background: var(--color-gray-light); border-radius: 2px;">
                                ${address.street || 'N/A'}<br>
                                ${address.apartment ? address.apartment + '<br>' : ''}
                                ${address.city || ''} ${address.postalCode || ''}<br>
                                ${address.country || order.shippingCountry || 'N/A'}
                            </div>
                        </div>
                        <div style="margin-top: var(--space-sm); margin-bottom: var(--space-sm);">
                            <strong>Chapters Purchased:</strong> ${(order.chaptersPurchased || []).join(', ') || 'N/A'}<br>
                            <strong>Sizes Purchased:</strong> ${(order.sizesPurchased || []).join(', ') || 'N/A'}
                        </div>
                        <div style="margin-top: var(--space-sm);">
                            <strong>Items:</strong>
                            <ul style="margin-top: var(--space-xs); padding-left: var(--space-lg);">
                                ${order.cart.map(item => `
                                    <li>${item.name || 'Product'} - ${item.size} / ${item.color} × ${item.quantity} - €${(item.price * item.quantity).toFixed(2)}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });

            modalContent.innerHTML = `
                <button class="close-modal" style="position: absolute; top: var(--space-md); right: var(--space-md); background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-light);">&times;</button>
                <h2 style="margin-bottom: var(--space-lg);">Customer Details: ${customer.email}</h2>
                
                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Profile Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); font-size: 0.875rem;">
                        <div><strong>Name:</strong> ${customer.profile?.name || 'N/A'}</div>
                        <div><strong>Email:</strong> ${customer.email}</div>
                        <div><strong>Password:</strong> <span style="font-family: monospace;">${customer.password || 'Not set'}</span></div>
                        <div><strong>Last Login:</strong> ${customer.lastLogin ? new Date(customer.lastLogin).toLocaleString() : 'Never'}</div>
                        <div><strong>Total Orders:</strong> ${customer.totalOrders}</div>
                        <div><strong>Total Spent:</strong> €${customer.totalSpent.toFixed(2)}</div>
                        <div><strong>Favorites:</strong> ${customer.favorites.length} items</div>
                        <div><strong>Last Updated:</strong> ${customer.updatedAt ? new Date(customer.updatedAt).toLocaleString() : 'N/A'}</div>
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Shipping Address</h3>
                    <div style="font-size: 0.875rem; padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                        ${latestAddress 
                            ? `${latestAddress.street || 'N/A'}<br>${latestAddress.apartment ? latestAddress.apartment + '<br>' : ''}${latestAddress.city || ''} ${latestAddress.postalCode || ''}<br>${latestAddress.country || 'N/A'}`
                            : 'No address on file'
                        }
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Favorites</h3>
                    <div style="font-size: 0.875rem;">
                        ${customer.favorites.length > 0 
                            ? customer.favorites.map(fav => {
                                // Get product name from ProductsAPI if available
                                let productName = `Product ID: ${fav}`;
                                if (window.ProductsAPI && window.ProductsAPI.getById) {
                                    const product = window.ProductsAPI.getById(fav);
                                    if (product && product.name) {
                                        productName = product.name;
                                    }
                                }
                                return `<span style="display: inline-block; padding: 4px 8px; background: var(--color-gray-light); margin: 4px; border-radius: 2px;">${productName}</span>`;
                            }).join('')
                            : 'No favorites'
                        }
                    </div>
                </div>

                <div>
                    <h3 style="margin-bottom: var(--space-sm);">Order History (${customer.orders.length})</h3>
                    ${ordersHtml || '<p>No orders yet</p>'}
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal handlers
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function exportToCSV() {
            if (!allCustomersData) {
                alert('Please load customers first');
                return;
            }

            // Create CSV content
            let csv = 'Email,Name,Password,Last Login,Total Orders,Total Spent,Last Order Date,Sizes Purchased,Chapters Purchased,Favorites Count,Payment Methods\n';
            
            allCustomersData.forEach(customer => {
                const name = customer.profile?.name || customer.email.split('@')[0];
                const password = customer.password || 'Not set';
                const lastLogin = customer.lastLogin ? new Date(customer.lastLogin).toLocaleString() : 'Never';
                const lastOrderDate = customer.lastOrderDate || 'Never';
                
                // Get all sizes
                const allSizes = new Set();
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => allSizes.add(size));
                    }
                });
                const sizesStr = Array.from(allSizes).sort().join('; ') || 'None';
                
                // Get all chapters
                const allChapters = new Set();
                customer.orders.forEach(order => {
                    if (order.chaptersPurchased && Array.isArray(order.chaptersPurchased)) {
                        order.chaptersPurchased.forEach(chapter => allChapters.add(chapter));
                    }
                });
                const chaptersStr = Array.from(allChapters).join('; ') || 'None';
                
                const paymentMethods = new Set();
                customer.orders.forEach(order => {
                    if (order.paymentMethod?.card) {
                        paymentMethods.add(`${order.paymentMethod.card.brand} •••• ${order.paymentMethod.card.last4}`);
                    }
                });
                const paymentMethodsStr = Array.from(paymentMethods).join('; ') || 'None';
                
                csv += `"${customer.email}","${name}","${password}","${lastLogin}",${customer.totalOrders},${customer.totalSpent.toFixed(2)},"${lastOrderDate}","${sizesStr}","${chaptersStr}",${customer.favorites.length},"${paymentMethodsStr}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Bind buttons
        document.getElementById('load-customers-btn').addEventListener('click', loadCustomers);
        document.getElementById('export-customers-btn').addEventListener('click', exportToCSV);
    </script>
</body>
</html>

