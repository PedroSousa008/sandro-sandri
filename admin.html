<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sandro Sandri</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Arapey:ital@0;1&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pages.css">
    <style>
        .admin-dashboard {
            padding: calc(var(--nav-height) + var(--space-lg)) var(--space-md) var(--space-xl);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-header {
            margin-bottom: var(--space-xl);
        }
        
        .admin-title {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            color: var(--color-navy);
            margin-bottom: var(--space-sm);
        }
        
        .admin-subtitle {
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--color-text-light);
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        
        .admin-stat-card {
            background: var(--color-white);
            padding: var(--space-md);
            border: 1px solid var(--color-gray);
            border-radius: 4px;
        }
        
        .admin-stat-label {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: var(--space-xs);
        }
        
        .admin-stat-value {
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--color-navy);
        }
        
        .admin-actions {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }
        
        .admin-action-btn {
            padding: var(--space-sm) var(--space-lg);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .admin-action-btn-primary {
            background: var(--color-navy);
            color: var(--color-white);
        }
        
        .admin-action-btn-primary:hover {
            background: var(--color-navy-dark);
        }
        
        .admin-action-btn-secondary {
            background: var(--color-white);
            color: var(--color-navy);
            border: 1px solid var(--color-navy);
        }
        
        .admin-action-btn-secondary:hover {
            background: var(--color-gray-light);
        }
        
        .admin-section {
            background: var(--color-white);
            padding: var(--space-lg);
            border: 1px solid var(--color-gray);
            border-radius: 4px;
            margin-bottom: var(--space-lg);
        }
        
        .admin-section-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            color: var(--color-navy);
            margin-bottom: var(--space-md);
        }
        
        .admin-draft-list {
            list-style: none;
            padding: 0;
        }
        
        .admin-draft-item {
            padding: var(--space-sm);
            border-bottom: 1px solid var(--color-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-draft-item:last-child {
            border-bottom: none;
        }
        
        .admin-draft-info {
            flex: 1;
        }
        
        .admin-draft-key {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text);
        }
        
        .admin-draft-preview {
            font-family: var(--font-sans);
            font-size: 0.75rem;
            color: var(--color-text-light);
            margin-top: var(--space-xs);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav scrolled">
        <a href="index.html" class="nav-logo">Sandro Sandri</a>
        <div class="nav-right">
            <a href="index.html" class="nav-link">View Website</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="admin-dashboard">
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <p class="admin-subtitle">Manage your website content and view analytics</p>
        </div>

        <div class="admin-stats">
            <div class="admin-stat-card">
                <div class="admin-stat-label">Online Users</div>
                <div class="admin-stat-value" id="dashboard-online-count">0</div>
                <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: var(--space-xs);">
                    Active users on website
                </div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-label">Users on Checkout</div>
                <div class="admin-stat-value" id="dashboard-checkout-count">0</div>
                <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: var(--space-xs);">
                    Active purchase intent
                </div>
            </div>
        </div>

        <div class="admin-actions">
            <button class="admin-action-btn admin-action-btn-secondary" id="reset-inventory-btn" style="background: #4caf50; color: white;">Reset Inventory to Full Stock</button>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Stock</h2>
            <div style="margin-bottom: var(--space-md);">
                <button class="admin-action-btn admin-action-btn-primary" id="load-stock-btn">Load Stock Data</button>
            </div>
            <div id="stock-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading stock data...
            </div>
            <div id="stock-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="stock-table-container" style="overflow-x: auto; display: none;">
                <table id="stock-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-gray-light); z-index: 10;">T-Shirt</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">XS</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">S</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">M</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">L</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">XL</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="stock-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Customer Information</h2>
            <div style="margin-bottom: var(--space-md);">
                <button class="admin-action-btn admin-action-btn-primary" id="load-customers-btn">Load All Customers</button>
                <button class="admin-action-btn admin-action-btn-secondary" id="export-customers-btn" style="display: none;">Export to CSV</button>
            </div>
            <div id="customers-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading customer data...
            </div>
            <div id="customers-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="customers-summary" style="display: none; margin-bottom: var(--space-md); padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                <strong>Total Customers:</strong> <span id="total-customers-count">0</span>
            </div>
            <div id="customers-table-container" style="overflow-x: auto; display: none;">
                <table id="customers-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-gray-light); z-index: 10;">Email</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Name</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Password</th>
                            <th id="last-login-header" style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600; cursor: pointer; user-select: none; position: relative;" title="Click to sort by Last Login">
                                Last Login
                                <span id="last-login-sort-indicator" style="margin-left: 4px; font-size: 0.75rem;">↕</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Total Orders</th>
                            <th style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray); font-weight: 600;">Total Spent</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Last Order</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Sizes</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Chapters</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Favorites</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Address</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Payment Methods</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Size Selection Statistics</h2>
            <div id="size-stats-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading size statistics...
            </div>
            <div id="size-stats-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="size-stats-table-container" style="overflow-x: auto; display: none;">
                <table id="size-stats-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Size</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Total Customers</th>
                        </tr>
                    </thead>
                    <tbody id="size-stats-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Quick Links</h2>
            <div class="admin-actions">
                <a href="index.html" class="admin-action-btn admin-action-btn-secondary">Home Page</a>
                <a href="collection.html" class="admin-action-btn admin-action-btn-secondary">Collection</a>
                <a href="product.html" class="admin-action-btn admin-action-btn-secondary">Product Page</a>
            </div>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/activity-tracker.js"></script>
    <script src="js/admin.js"></script>
    <script>
        // Check authentication
        if (!window.auth || !window.auth.isOwner()) {
            window.location.href = 'login.html';
        }
        
        // Initialize dashboard
        async function updateDashboard() {
            try {
                // Fetch active users from server
                const response = await fetch('/api/admin?endpoint=activity');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('dashboard-online-count').textContent = data.onlineUsers || 0;
                        document.getElementById('dashboard-checkout-count').textContent = data.checkoutUsers || 0;
                    }
                }
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        // Bind reset inventory button
        document.getElementById('reset-inventory-btn').addEventListener('click', () => {
            if (confirm('Reset all inventory to full stock? This will restore all sizes to their maximum quantities (XS: 10, S: 20, M: 50, L: 50, XL: 20 per model).')) {
                if (window.InventoryAPI && window.InventoryAPI.reset) {
                    window.InventoryAPI.reset();
                    alert('Inventory reset successfully! All products now have full stock.');
                    // Reload to see changes
                    window.location.reload();
                } else {
                    alert('Inventory API not available. Please refresh the page.');
                }
            }
        });
        
        // Update dashboard every 3 seconds for real-time updates
        setInterval(() => {
            updateDashboard();
        }, 3000);
        updateDashboard();

        // Customer Information Management
        let allCustomersData = null;
        let originalCustomersOrder = null; // Store original order
        let lastLoginSortState = 0; // 0 = original, 1 = newest first, 2 = oldest first

        async function loadCustomers() {
            const loadingEl = document.getElementById('customers-loading');
            const errorEl = document.getElementById('customers-error');
            const tableContainer = document.getElementById('customers-table-container');
            const summaryEl = document.getElementById('customers-summary');
            const tbody = document.getElementById('customers-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';
            summaryEl.style.display = 'none';

            try {
                const response = await fetch('/api/admin?endpoint=customers');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to load customers');
                }

                allCustomersData = data.customers;
                
                // Store original order on first load
                if (!originalCustomersOrder) {
                    originalCustomersOrder = [...data.customers];
                }
                
                // Update summary
                document.getElementById('total-customers-count').textContent = data.totalCustomers;
                summaryEl.style.display = 'block';
                
                // Render table
                renderCustomersTable(allCustomersData);
                tableContainer.style.display = 'block';
                document.getElementById('export-customers-btn').style.display = 'inline-block';
                
                // Setup Last Login column sorting
                setupLastLoginSorting();

            } catch (error) {
                console.error('Error loading customers:', error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customers-tbody');
            
            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">
                            No customers found
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate totals across all customers
            const grandTotalOrders = customers.reduce((sum, c) => sum + (c.totalOrders || 0), 0);
            const grandTotalSpent = customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0);
            const grandTotalFavorites = customers.reduce((sum, c) => sum + (c.favorites?.length || 0), 0);

            let html = '';
            customers.forEach((customer, index) => {
                const name = customer.profile?.name || customer.email.split('@')[0];
                const password = customer.password || 'Not set';
                const lastLogin = customer.lastLogin 
                    ? new Date(customer.lastLogin).toLocaleString()
                    : 'Never';
                const lastOrderDate = customer.lastOrderDate 
                    ? new Date(customer.lastOrderDate).toLocaleDateString()
                    : 'Never';
                
                // Get all sizes from profile and orders
                const allSizes = new Set();
                
                // First, check the customer's profile size (their selected size preference)
                if (customer.profile && customer.profile.size) {
                    allSizes.add(customer.profile.size);
                }
                
                // Then, get sizes from all orders
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => allSizes.add(size));
                    } else if (order.cart) {
                        order.cart.forEach(item => {
                            if (item.size) allSizes.add(item.size);
                        });
                    }
                });
                const sizesList = Array.from(allSizes).sort().join(', ') || 'None';
                
                // Get all chapters purchased
                const allChapters = new Set();
                customer.orders.forEach(order => {
                    if (order.chaptersPurchased && Array.isArray(order.chaptersPurchased)) {
                        order.chaptersPurchased.forEach(chapter => allChapters.add(chapter));
                    }
                });
                const chaptersList = Array.from(allChapters).join(', ') || 'None';
                
                // Get unique payment methods
                const paymentMethods = new Set();
                customer.orders.forEach(order => {
                    if (order.paymentMethod) {
                        if (order.paymentMethod.card) {
                            const cardInfo = `${order.paymentMethod.card.brand.toUpperCase()} •••• ${order.paymentMethod.card.last4}`;
                            paymentMethods.add(cardInfo);
                        }
                    }
                });
                const paymentMethodsList = Array.from(paymentMethods).join(', ') || 'None';
                
                // Get address from profile first, then from most recent order
                let customerAddress = 'None';
                if (customer.profile && customer.profile.address) {
                    // Profile address is stored as a single string
                    customerAddress = customer.profile.address;
                } else if (customer.orders && customer.orders.length > 0) {
                    // Fall back to most recent order address
                    const sortedOrders = [...customer.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const latestOrder = sortedOrders[0];
                    if (latestOrder.shippingAddress) {
                        const addr = latestOrder.shippingAddress;
                        customerAddress = `${addr.street || ''}${addr.apartment ? ', ' + addr.apartment : ''}, ${addr.city || ''} ${addr.postalCode || ''}, ${addr.country || latestOrder.shippingCountry || ''}`.trim();
                        if (customerAddress.endsWith(',')) {
                            customerAddress = customerAddress.slice(0, -1);
                        }
                    } else if (latestOrder.shippingCountry) {
                        customerAddress = latestOrder.shippingCountry;
                    }
                }

                const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                
                html += `
                    <tr ${rowClass} data-email="${customer.email}">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); position: sticky; left: 0; background: inherit; font-weight: 500;">
                            ${customer.email}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray);">
                            ${name}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; font-family: monospace;">
                            ${password}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${lastLogin}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${customer.totalOrders}
                        </td>
                        <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">
                            €${customer.totalSpent.toFixed(2)}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${lastOrderDate}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${sizesList}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${chaptersList}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${customer.favorites.length}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; max-width: 200px;">
                            ${customerAddress}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; max-width: 150px;">
                            ${paymentMethodsList || 'None'}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <button class="view-customer-details" data-email="${customer.email}" style="padding: 4px 8px; font-size: 0.75rem; background: var(--color-navy); color: white; border: none; cursor: pointer; border-radius: 2px;">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            // Add total row at the end
            html += `
                <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                    <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">
                        <strong>GRAND TOTAL:</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${customers.length}</strong>
                    </td>
                    <td colspan="2" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${grandTotalOrders}</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">
                        <strong>€${grandTotalSpent.toFixed(2)}</strong>
                    </td>
                    <td colspan="3" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${grandTotalFavorites}</strong>
                    </td>
                    <td style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td colspan="2" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                </tr>
            `;
            
            tbody.innerHTML = html;

            // Add click handlers for view details
            document.querySelectorAll('.view-customer-details').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    showCustomerDetails(email);
                });
            });
            
            // Render size statistics table
            renderSizeStatistics(customers);
        }
        
        function renderSizeStatistics(customers) {
            const sizeStatsContainer = document.getElementById('size-stats-table-container');
            const sizeStatsTbody = document.getElementById('size-stats-tbody');
            const sizeStatsLoading = document.getElementById('size-stats-loading');
            const sizeStatsError = document.getElementById('size-stats-error');
            
            if (!customers || customers.length === 0) {
                sizeStatsContainer.style.display = 'none';
                return;
            }
            
            // Count size selections across all customers
            const sizeCounts = {
                'XS': 0,
                'S': 0,
                'M': 0,
                'L': 0,
                'XL': 0
            };
            
            customers.forEach(customer => {
                const customerSizes = new Set();
                
                // Get sizes from profile
                if (customer.profile && customer.profile.size) {
                    customerSizes.add(customer.profile.size);
                }
                
                // Get sizes from orders
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => customerSizes.add(size));
                    } else if (order.cart) {
                        order.cart.forEach(item => {
                            if (item.size) customerSizes.add(item.size);
                        });
                    }
                });
                
                // Count each size for this customer
                customerSizes.forEach(size => {
                    const normalizedSize = size.toUpperCase();
                    if (sizeCounts.hasOwnProperty(normalizedSize)) {
                        sizeCounts[normalizedSize]++;
                    }
                });
            });
            
            // Render table
            const sizes = ['XS', 'S', 'M', 'L', 'XL'];
            let html = '';
            
            sizes.forEach((size, index) => {
                const count = sizeCounts[size] || 0;
                const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                
                html += `
                    <tr ${rowClass}>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 500;">
                            ${size}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${count}
                        </td>
                    </tr>
                `;
            });
            
            // Add total row
            const totalCustomers = Object.values(sizeCounts).reduce((sum, count) => sum + count, 0);
            html += `
                <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>TOTAL</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${totalCustomers}</strong>
                    </td>
                </tr>
            `;
            
            sizeStatsTbody.innerHTML = html;
            sizeStatsContainer.style.display = 'block';
            sizeStatsLoading.style.display = 'none';
            sizeStatsError.style.display = 'none';
        }

        function showCustomerDetails(email) {
            const customer = allCustomersData.find(c => c.email === email);
            if (!customer) return;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: var(--space-lg);';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: var(--space-xl); border-radius: 4px; position: relative;';
            
            // Get address from profile first, then from most recent order
            let latestAddress = null;
            if (customer.profile && customer.profile.address) {
                // Profile address is stored as a string, convert to object format for display
                latestAddress = {
                    street: customer.profile.address,
                    city: customer.profile.city || '',
                    postalCode: customer.profile.postalCode || '',
                    country: customer.profile.country || ''
                };
            } else if (customer.orders.length > 0) {
                const sortedOrders = [...customer.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                latestAddress = sortedOrders[0].shippingAddress;
            }
            
            let ordersHtml = '';
            customer.orders.forEach((order, index) => {
                const orderDate = new Date(order.createdAt).toLocaleString();
                const paymentInfo = order.paymentMethod?.card 
                    ? `${order.paymentMethod.card.brand.toUpperCase()} •••• ${order.paymentMethod.card.last4} (Exp: ${order.paymentMethod.card.exp_month}/${order.paymentMethod.card.exp_year})`
                    : 'N/A';
                
                const address = order.shippingAddress || {};
                const addressStr = address.street 
                    ? `${address.street}${address.apartment ? ', ' + address.apartment : ''}, ${address.city}, ${address.postalCode}, ${address.country || order.shippingCountry || 'N/A'}`
                    : (order.shippingCountry || 'N/A');
                
                ordersHtml += `
                    <div style="border: 1px solid var(--color-gray); padding: var(--space-md); margin-bottom: var(--space-md); border-radius: 4px;">
                        <h4 style="margin-bottom: var(--space-sm);">Order #${order.order_number || order.id}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); font-size: 0.875rem; margin-bottom: var(--space-sm);">
                            <div><strong>Order ID:</strong> ${order.order_id || order.id}</div>
                            <div><strong>User ID:</strong> ${order.user_id || customer.email}</div>
                            <div><strong>Order Number:</strong> ${order.order_number || order.id}</div>
                            <div><strong>Status:</strong> ${order.status}</div>
                            <div><strong>Date:</strong> ${orderDate}</div>
                            <div><strong>Currency:</strong> ${order.currency || 'EUR'}</div>
                            <div><strong>Subtotal:</strong> €${(order.subtotal || 0).toFixed(2)}</div>
                            <div><strong>Shipping Cost:</strong> €${(order.shipping_cost || order.shipping || 0).toFixed(2)}</div>
                            <div><strong>Tax:</strong> €${(order.tax || 0).toFixed(2)}</div>
                            <div><strong>Total:</strong> €${(order.total || 0).toFixed(2)}</div>
                            <div><strong>Payment Method:</strong> ${paymentInfo}</div>
                            <div><strong>Stripe Session:</strong> ${order.stripeSessionId || 'N/A'}</div>
                        </div>
                        <div style="margin-top: var(--space-sm); margin-bottom: var(--space-sm);">
                            <strong>Shipping Address:</strong>
                            <div style="font-size: 0.875rem; margin-top: var(--space-xs); padding: var(--space-xs); background: var(--color-gray-light); border-radius: 2px;">
                                ${address.street || 'N/A'}<br>
                                ${address.apartment ? address.apartment + '<br>' : ''}
                                ${address.city || ''} ${address.postalCode || ''}<br>
                                ${address.country || order.shippingCountry || 'N/A'}
                            </div>
                        </div>
                        <div style="margin-top: var(--space-sm); margin-bottom: var(--space-sm);">
                            <strong>Chapters Purchased:</strong> ${(order.chaptersPurchased || []).join(', ') || 'N/A'}<br>
                            <strong>Sizes Purchased:</strong> ${(order.sizesPurchased || []).join(', ') || 'N/A'}
                        </div>
                        <div style="margin-top: var(--space-sm);">
                            <strong>Items:</strong>
                            <ul style="margin-top: var(--space-xs); padding-left: var(--space-lg);">
                                ${order.cart.map(item => `
                                    <li>${item.name || 'Product'} - ${item.size} / ${item.color} × ${item.quantity} - €${(item.price * item.quantity).toFixed(2)}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });

            modalContent.innerHTML = `
                <button class="close-modal" style="position: absolute; top: var(--space-md); right: var(--space-md); background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-light);">&times;</button>
                <h2 style="margin-bottom: var(--space-lg);">Customer Details: ${customer.email}</h2>
                
                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Profile Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); font-size: 0.875rem;">
                        <div><strong>Name:</strong> ${customer.profile?.name || 'N/A'}</div>
                        <div><strong>Email:</strong> ${customer.email}</div>
                        <div><strong>Password:</strong> <span style="font-family: monospace;">${customer.password || 'Not set'}</span></div>
                        <div><strong>Last Login:</strong> ${customer.lastLogin ? new Date(customer.lastLogin).toLocaleString() : 'Never'}</div>
                        <div><strong>Total Orders:</strong> ${customer.totalOrders}</div>
                        <div><strong>Total Spent:</strong> €${customer.totalSpent.toFixed(2)}</div>
                        <div><strong>Favorites:</strong> ${customer.favorites.length} items</div>
                        <div><strong>Last Updated:</strong> ${customer.updatedAt ? new Date(customer.updatedAt).toLocaleString() : 'N/A'}</div>
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Shipping Address</h3>
                    <div style="font-size: 0.875rem; padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                        ${latestAddress 
                            ? `${latestAddress.street || 'N/A'}<br>${latestAddress.apartment ? latestAddress.apartment + '<br>' : ''}${latestAddress.city || ''} ${latestAddress.postalCode || ''}<br>${latestAddress.country || 'N/A'}`
                            : 'No address on file'
                        }
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Favorites</h3>
                    <div style="font-size: 0.875rem;">
                        ${customer.favorites.length > 0 
                            ? customer.favorites.map(fav => {
                                // Get product name from ProductsAPI if available
                                let productName = `Product ID: ${fav}`;
                                if (window.ProductsAPI && window.ProductsAPI.getById) {
                                    const product = window.ProductsAPI.getById(fav);
                                    if (product && product.name) {
                                        productName = product.name;
                                    }
                                }
                                return `<span style="display: inline-block; padding: 4px 8px; background: var(--color-gray-light); margin: 4px; border-radius: 2px;">${productName}</span>`;
                            }).join('')
                            : 'No favorites'
                        }
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Order History (${customer.orders.length})</h3>
                    ${ordersHtml || '<p>No orders yet</p>'}
                </div>
                
                <div style="margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 2px solid var(--color-gray); text-align: right;">
                    <button class="delete-customer-btn" data-email="${customer.email}" style="padding: var(--space-sm) var(--space-lg); background: #d32f2f; color: white; border: none; cursor: pointer; border-radius: 4px; font-family: var(--font-sans); font-size: 0.875rem; font-weight: 500; letter-spacing: 0.05em;">
                        Delete Customer
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal handlers
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // Delete customer handler
            const deleteBtn = modal.querySelector('.delete-customer-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    const customerEmail = deleteBtn.dataset.email;
                    const customerName = customer.profile?.name || customerEmail;
                    
                    if (!confirm(`Are you sure you want to delete customer "${customerName}" (${customerEmail})?\n\nThis will permanently delete:\n- All customer data\n- All orders\n- All favorites\n- Profile information\n\nThis action cannot be undone!`)) {
                        return;
                    }
                    
                    // Double confirmation
                    if (!confirm(`FINAL CONFIRMATION: Delete "${customerName}"?\n\nThis action is PERMANENT and CANNOT be undone!`)) {
                        return;
                    }
                    
                    deleteBtn.disabled = true;
                    deleteBtn.textContent = 'Deleting...';
                    
                    try {
                        const response = await fetch(`/api/admin?endpoint=customers&email=${encodeURIComponent(customerEmail)}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            alert(`Customer "${customerName}" has been deleted successfully.`);
                            document.body.removeChild(modal);
                            // Reload customers table
                            loadCustomers();
                        } else {
                            throw new Error(data.error || 'Failed to delete customer');
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        alert(`Error deleting customer: ${error.message}`);
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'Delete Customer';
                    }
                });
            }
        }

        function exportToCSV() {
            if (!allCustomersData) {
                alert('Please load customers first');
                return;
            }

            // Create CSV content
            let csv = 'Email,Name,Password,Last Login,Total Orders,Total Spent,Last Order Date,Sizes Purchased,Chapters Purchased,Favorites Count,Payment Methods\n';
            
            allCustomersData.forEach(customer => {
                const name = customer.profile?.name || customer.email.split('@')[0];
                const password = customer.password || 'Not set';
                const lastLogin = customer.lastLogin ? new Date(customer.lastLogin).toLocaleString() : 'Never';
                const lastOrderDate = customer.lastOrderDate || 'Never';
                
                // Get all sizes
                const allSizes = new Set();
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => allSizes.add(size));
                    }
                });
                const sizesStr = Array.from(allSizes).sort().join('; ') || 'None';
                
                // Get all chapters
                const allChapters = new Set();
                customer.orders.forEach(order => {
                    if (order.chaptersPurchased && Array.isArray(order.chaptersPurchased)) {
                        order.chaptersPurchased.forEach(chapter => allChapters.add(chapter));
                    }
                });
                const chaptersStr = Array.from(allChapters).join('; ') || 'None';
                
                const paymentMethods = new Set();
                customer.orders.forEach(order => {
                    if (order.paymentMethod?.card) {
                        paymentMethods.add(`${order.paymentMethod.card.brand} •••• ${order.paymentMethod.card.last4}`);
                    }
                });
                const paymentMethodsStr = Array.from(paymentMethods).join('; ') || 'None';
                
                csv += `"${customer.email}","${name}","${password}","${lastLogin}",${customer.totalOrders},${customer.totalSpent.toFixed(2)},"${lastOrderDate}","${sizesStr}","${chaptersStr}",${customer.favorites.length},"${paymentMethodsStr}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Bind buttons
        document.getElementById('load-customers-btn').addEventListener('click', loadCustomers);
        document.getElementById('export-customers-btn').addEventListener('click', exportToCSV);

        // Last Login Column Sorting
        function setupLastLoginSorting() {
            const header = document.getElementById('last-login-header');
            const indicator = document.getElementById('last-login-sort-indicator');
            
            if (!header) return;
            
            // Remove existing listener if any
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            // Add click listener
            document.getElementById('last-login-header').addEventListener('click', () => {
                if (!allCustomersData || allCustomersData.length === 0) return;
                
                // Cycle through sort states: 0 -> 1 -> 2 -> 0
                lastLoginSortState = (lastLoginSortState + 1) % 3;
                
                let sortedCustomers;
                
                if (lastLoginSortState === 0) {
                    // Original order
                    sortedCustomers = originalCustomersOrder ? [...originalCustomersOrder] : [...allCustomersData];
                    indicator.textContent = '↕';
                    indicator.style.color = '';
                } else if (lastLoginSortState === 1) {
                    // Newest first (most recent login first)
                    sortedCustomers = [...allCustomersData].sort((a, b) => {
                        const dateA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                        const dateB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                        return dateB - dateA; // Descending (newest first)
                    });
                    indicator.textContent = '↓';
                    indicator.style.color = 'var(--color-navy)';
                } else {
                    // Oldest first (least recent login first)
                    sortedCustomers = [...allCustomersData].sort((a, b) => {
                        const dateA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                        const dateB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                        // Put "Never" (0) at the end
                        if (dateA === 0 && dateB === 0) return 0;
                        if (dateA === 0) return 1;
                        if (dateB === 0) return -1;
                        return dateA - dateB; // Ascending (oldest first)
                    });
                    indicator.textContent = '↑';
                    indicator.style.color = 'var(--color-navy)';
                }
                
                // Re-render table with sorted data
                renderCustomersTable(sortedCustomers);
            });
        }

        // Stock Table Management
        async function loadStock() {
            const loadingEl = document.getElementById('stock-loading');
            const errorEl = document.getElementById('stock-error');
            const tableContainer = document.getElementById('stock-table-container');
            const tbody = document.getElementById('stock-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';

            try {
                // Fetch current inventory
                const inventoryResponse = await fetch('/api/inventory/stock');

                if (!inventoryResponse.ok) {
                    throw new Error('Failed to load inventory');
                }

                const inventoryData = await inventoryResponse.json();

                // Get products from window.ProductsAPI
                const products = window.ProductsAPI ? window.ProductsAPI.getAll() : [];
                const tshirtProducts = products.filter(p => p.category === 'tshirts');

                // Get stock levels for each product
                const stockData = tshirtProducts.map(product => {
                    const productInventory = inventoryData.find(inv => inv.productId === product.id);
                    const stock = {
                        XS: 0,
                        S: 0,
                        M: 0,
                        L: 0,
                        XL: 0
                    };

                    // Get stock from inventory API response
                    if (productInventory && productInventory.sizes) {
                        productInventory.sizes.forEach(sizeInfo => {
                            if (stock.hasOwnProperty(sizeInfo.size)) {
                                stock[sizeInfo.size] = sizeInfo.stock || 0;
                            }
                        });
                    }

                    // Calculate total stock
                    const totalStock = stock.XS + stock.S + stock.M + stock.L + stock.XL;

                    return {
                        productId: product.id,
                        name: product.name,
                        stock: stock,
                        totalStock: totalStock
                    };
                });

                // Render table
                let html = '';
                let grandTotalXS = 0, grandTotalS = 0, grandTotalM = 0, grandTotalL = 0, grandTotalXL = 0, grandTotalAll = 0;

                stockData.forEach((item, index) => {
                    grandTotalXS += item.stock.XS;
                    grandTotalS += item.stock.S;
                    grandTotalM += item.stock.M;
                    grandTotalL += item.stock.L;
                    grandTotalXL += item.stock.XL;
                    grandTotalAll += item.totalStock;

                    const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                    
                    // Highlight low stock (less than 5) in red
                    const xsStyle = item.stock.XS < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const sStyle = item.stock.S < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const mStyle = item.stock.M < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const lStyle = item.stock.L < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const xlStyle = item.stock.XL < 5 ? 'color: #c00; font-weight: 600;' : '';
                    
                    html += `
                        <tr ${rowClass}>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); position: sticky; left: 0; background: inherit; font-weight: 500;">
                                ${item.name}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${xsStyle}">
                                ${item.stock.XS}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${sStyle}">
                                ${item.stock.S}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${mStyle}">
                                ${item.stock.M}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${lStyle}">
                                ${item.stock.L}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${xlStyle}">
                                ${item.stock.XL}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">
                                ${item.totalStock}
                            </td>
                        </tr>
                    `;
                });

                // Add total row
                html += `
                    <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                        <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">
                            <strong>TOTAL:</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalXS}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalS}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalM}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalL}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalXL}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalAll}</strong>
                        </td>
                    </tr>
                `;

                tbody.innerHTML = html;
                tableContainer.style.display = 'block';

            } catch (error) {
                console.error('Error loading stock:', error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        document.getElementById('load-stock-btn').addEventListener('click', loadStock);
    </script>
</body>
</html>

