<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sandro Sandri</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allura&family=Arapey:ital@0;1&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pages.css">
    <style>
        .admin-dashboard {
            padding: calc(var(--nav-height) + var(--space-lg)) var(--space-md) var(--space-xl);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-header {
            margin-bottom: var(--space-xl);
        }
        
        .admin-title {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            color: var(--color-navy);
            margin-bottom: var(--space-sm);
        }
        
        .admin-subtitle {
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--color-text-light);
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        
        .admin-stat-card {
            background: var(--color-white);
            padding: var(--space-md);
            border: 1px solid var(--color-gray);
            border-radius: 4px;
        }
        
        .admin-stat-label {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: var(--space-xs);
        }
        
        .admin-stat-value {
            font-family: var(--font-serif);
            font-size: 2rem;
            color: var(--color-navy);
        }
        
        .admin-actions {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }
        
        .admin-action-btn {
            padding: var(--space-sm) var(--space-lg);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .admin-action-btn-primary {
            background: var(--color-navy);
            color: var(--color-white);
        }
        
        .admin-action-btn-primary:hover {
            background: var(--color-navy-dark);
        }
        
        .admin-action-btn-secondary {
            background: var(--color-white);
            color: var(--color-navy);
            border: 1px solid var(--color-navy);
        }
        
        .admin-action-btn-secondary:hover {
            background: var(--color-gray-light);
        }
        
        .admin-section {
            background: var(--color-white);
            padding: var(--space-lg);
            border: 1px solid var(--color-gray);
            border-radius: 4px;
            margin-bottom: var(--space-lg);
        }
        
        .admin-section-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            color: var(--color-navy);
            margin-bottom: var(--space-md);
        }
        
        .admin-draft-list {
            list-style: none;
            padding: 0;
        }
        
        .admin-draft-item {
            padding: var(--space-sm);
            border-bottom: 1px solid var(--color-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-draft-item:last-child {
            border-bottom: none;
        }
        
        .admin-draft-info {
            flex: 1;
        }
        
        .admin-draft-key {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text);
        }
        
        .admin-draft-preview {
            font-family: var(--font-sans);
            font-size: 0.75rem;
            color: var(--color-text-light);
            margin-top: var(--space-xs);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav scrolled">
        <a href="index.html" class="nav-logo">Sandro Sandri</a>
        <div class="nav-right">
            <a href="index.html" class="nav-link">View Website</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="admin-dashboard">
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <p class="admin-subtitle">Manage your website content and view analytics</p>
        </div>

        <div class="admin-stats">
            <div class="admin-stat-card">
                <div class="admin-stat-label">Online Users</div>
                <div class="admin-stat-value" id="dashboard-online-count">0</div>
                <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: var(--space-xs);">
                    Active users on website
                </div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-label">Users on Checkout</div>
                <div class="admin-stat-value" id="dashboard-checkout-count">0</div>
                <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: var(--space-xs);">
                    Active purchase intent
                </div>
            </div>
        </div>

        <!-- Site Commerce Mode Control -->
        <div class="admin-section" style="margin-top: var(--space-xl);">
            <h2 class="admin-section-title">Site Commerce Mode</h2>
            <div style="margin-bottom: var(--space-md); padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                <div style="font-family: var(--font-sans); font-size: 0.875rem; color: var(--color-text); margin-bottom: var(--space-sm);">
                    <strong>Current Store Mode:</strong> <span id="current-commerce-mode" style="color: var(--color-navy); font-weight: 600;">Loading...</span>
                </div>
                <div style="font-size: 0.75rem; color: var(--color-text-light);">
                    Control how customers interact with the storefront
                </div>
            </div>
            <div class="admin-actions">
                <button class="admin-action-btn admin-action-btn-primary" id="set-live-mode-btn" style="background: #4caf50;">Switch to Add to Cart</button>
                <button class="admin-action-btn admin-action-btn-primary" id="set-waitlist-mode-btn" style="background: #ff9800;">Switch to Join the Waitlist</button>
                <button class="admin-action-btn admin-action-btn-primary" id="set-early-access-mode-btn" style="background: #2196f3;">Switch to Early Access</button>
            </div>
        </div>

        <div class="admin-actions">
            <button class="admin-action-btn admin-action-btn-secondary" id="reset-inventory-btn" style="background: #4caf50; color: white;">Reset Inventory to Full Stock</button>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Stock</h2>
            <div style="margin-bottom: var(--space-md);">
                <button class="admin-action-btn admin-action-btn-primary" id="load-stock-btn">Load Stock Data</button>
            </div>
            <div id="stock-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading stock data...
            </div>
            <div id="stock-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="stock-table-container" style="overflow-x: auto; display: none;">
                <table id="stock-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-gray-light); z-index: 10;">T-Shirt</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">XS</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">S</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">M</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">L</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">XL</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="stock-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Customer Information</h2>
            <div style="margin-bottom: var(--space-md);">
                <button class="admin-action-btn admin-action-btn-primary" id="load-customers-btn">Load All Customers</button>
                <button class="admin-action-btn admin-action-btn-secondary" id="export-customers-btn" style="display: none;">Export to CSV</button>
            </div>
            <div id="customers-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading customer data...
            </div>
            <div id="customers-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="customers-summary" style="display: none; margin-bottom: var(--space-md); padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                <strong>Total Customers:</strong> <span id="total-customers-count">0</span>
            </div>
            <div id="customers-table-container" style="overflow-x: auto; display: none;">
                <table id="customers-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-gray-light); z-index: 10;">Email</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Name</th>
                            <!-- SECURITY: Password column removed -->
                            <th id="last-login-header" style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600; cursor: pointer; user-select: none; position: relative;" title="Click to sort by Last Login">
                                Last Login
                                <span id="last-login-sort-indicator" style="margin-left: 4px; font-size: 0.75rem;">↕</span>
                            </th>
                            <th id="total-orders-header" style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600; cursor: pointer; user-select: none; position: relative;" title="Click to sort by Total Orders">
                                Total Orders
                                <span id="total-orders-sort-indicator" style="margin-left: 4px; font-size: 0.75rem;">↕</span>
                            </th>
                            <th id="total-spent-header" style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray); font-weight: 600; cursor: pointer; user-select: none; position: relative;" title="Click to sort by Total Spent">
                                Total Spent
                                <span id="total-spent-sort-indicator" style="margin-left: 4px; font-size: 0.75rem;">↕</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Last Order</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Sizes</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Chapters</th>
                            <th id="favorites-header" style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600; cursor: pointer; user-select: none; position: relative;" title="Click to sort by Favorites">
                                Favorites
                                <span id="favorites-sort-indicator" style="margin-left: 4px; font-size: 0.75rem;">↕</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Address</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Payment Methods</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Size Selection Statistics</h2>
            <div id="size-stats-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading size statistics...
            </div>
            <div id="size-stats-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="size-stats-table-container" style="overflow-x: auto; display: none;">
                <table id="size-stats-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Size</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Total Customers</th>
                        </tr>
                    </thead>
                    <tbody id="size-stats-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Orders Management</h2>
            <div style="margin-bottom: var(--space-md);">
                <button class="admin-action-btn admin-action-btn-primary" id="load-orders-btn">Load All Orders</button>
            </div>
            <div id="orders-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading orders data...
            </div>
            <div id="orders-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="orders-summary" style="display: none; margin-bottom: var(--space-md); padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                <strong>Total Orders:</strong> <span id="total-orders-count">0</span>
            </div>
            <div id="orders-table-container" style="overflow-x: auto; display: none;">
                <table id="orders-table" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                    <thead>
                        <tr style="background: var(--color-gray-light);">
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-gray-light); z-index: 10;">Confirmation</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Order ID</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Name</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Email</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Phone</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Address</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">House</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">City</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Postal Code</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Country</th>
                            <th style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray); font-weight: 600;">Total Received</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Items Purchased</th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">Order Status</th>
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600;">Tracking Number</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chapter Management -->
        <div class="admin-section">
            <h2 class="admin-section-title">Chapter Management</h2>
            <div style="margin-bottom: var(--space-md);">
                <p style="font-family: var(--font-sans); font-size: 0.875rem; color: var(--color-text-light); margin-bottom: var(--space-md);">
                    Control which chapter is displayed on the website and set the commerce mode for each chapter. Only chapters marked as "Created" can have their modes changed.
                </p>
            </div>
            <div id="chapter-modes-loading" style="display: none; text-align: center; padding: var(--space-lg); color: var(--color-text-light);">
                Loading chapter modes...
            </div>
            <div id="chapter-modes-error" style="display: none; padding: var(--space-md); background: #fee; border: 1px solid #fcc; color: #c00; border-radius: 4px; margin-bottom: var(--space-md);"></div>
            <div id="chapter-modes-table-container" style="overflow-x: auto; display: none;">
                <table id="chapter-modes-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                    <thead>
                        <tr style="background: var(--color-navy); color: white;">
                            <th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 600; position: sticky; left: 0; background: var(--color-navy); z-index: 10;">
                                Chapter <span style="font-size: 0.75rem;">▼</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">
                                Join the Waitlist <span style="font-size: 0.75rem;">▼</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">
                                Early Access <span style="font-size: 0.75rem;">▼</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">
                                Add to Cart <span style="font-size: 0.75rem;">▼</span>
                            </th>
                            <th style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">
                                Created <span style="font-size: 0.75rem;">▼</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="chapter-modes-tbody">
                    </tbody>
                </table>
            </div>
            <div id="chapter-message" style="display: none; padding: var(--space-sm) var(--space-md); margin-top: var(--space-md); border-radius: 4px; font-family: var(--font-sans); font-size: 0.875rem;"></div>
        </div>

        <div class="admin-section">
            <h2 class="admin-section-title">Quick Links</h2>
            <div class="admin-actions">
                <a href="index.html" class="admin-action-btn admin-action-btn-secondary">Home Page</a>
                <a href="collection.html" class="admin-action-btn admin-action-btn-secondary">Collection</a>
                <a href="product.html" class="admin-action-btn admin-action-btn-secondary">Product Page</a>
            </div>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script src="js/products.js"></script>
    <script src="js/activity-tracker.js"></script>
    <script src="js/admin.js"></script>
    <script>
        // Check authentication
        if (!window.auth || !window.auth.isOwner()) {
            window.location.href = 'login.html';
        }
        
        // Initialize dashboard
        async function updateDashboard() {
            try {
                // Fetch active users from server
                const response = await fetch('/api/admin?endpoint=activity');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const onlineCount = data.onlineUsers || 0;
                        const checkoutCount = data.checkoutUsers || 0;
                        
                        // Update dashboard stats
                        document.getElementById('dashboard-online-count').textContent = onlineCount;
                        document.getElementById('dashboard-checkout-count').textContent = checkoutCount;
                        
                        // Update header admin bar counter (same tracking method)
                        const adminOnlineCount = document.getElementById('admin-online-count');
                        if (adminOnlineCount) {
                            adminOnlineCount.textContent = `${onlineCount} user${onlineCount !== 1 ? 's' : ''} online`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        // Bind reset inventory button
        document.getElementById('reset-inventory-btn').addEventListener('click', () => {
            if (confirm('Reset all inventory to full stock? This will restore all sizes to their maximum quantities (XS: 10, S: 20, M: 50, L: 50, XL: 20 per model).')) {
                if (window.InventoryAPI && window.InventoryAPI.reset) {
                    window.InventoryAPI.reset();
                    alert('Inventory reset successfully! All products now have full stock.');
                    // Reload to see changes
                    window.location.reload();
                } else {
                    alert('Inventory API not available. Please refresh the page.');
                }
            }
        });
        
        // Update dashboard every 3 seconds for real-time updates
        setInterval(() => {
            updateDashboard();
        }, 3000);
        updateDashboard();

        // Site Commerce Mode Management
        let currentCommerceMode = 'LIVE';

        async function loadCommerceMode() {
            try {
                const response = await fetch('/api/site-settings/commerce-mode');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentCommerceMode = data.commerce_mode || 'LIVE';
                        document.getElementById('current-commerce-mode').textContent = currentCommerceMode;
                    }
                }
            } catch (error) {
                console.error('Error loading commerce mode:', error);
            }
        }

        async function setCommerceMode(mode) {
            if (!confirm(`Are you sure you want to switch to ${mode} mode?`)) {
                return;
            }

            try {
                // Get JWT token from localStorage
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    alert('You must be logged in to change commerce mode.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch('/api/site-settings?setting=commerce-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    },
                    body: JSON.stringify({
                        commerce_mode: mode
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    currentCommerceMode = mode;
                    document.getElementById('current-commerce-mode').textContent = mode;
                    
                    // Show success message
                    alert(`Commerce mode successfully set to ${mode}`);
                    
                    // Reload to ensure all pages reflect the change
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert(`Error: ${data.error || 'Failed to update commerce mode'}`);
                }
            } catch (error) {
                console.error('Error setting commerce mode:', error);
                alert('Error updating commerce mode. Please try again.');
            }
        }

        // Bind commerce mode buttons
        document.getElementById('set-live-mode-btn').addEventListener('click', () => setCommerceMode('LIVE'));
        document.getElementById('set-waitlist-mode-btn').addEventListener('click', () => setCommerceMode('WAITLIST'));
        document.getElementById('set-early-access-mode-btn').addEventListener('click', () => setCommerceMode('EARLY_ACCESS'));

        // Load current mode on page load
        loadCommerceMode();

        // Customer Information Management
        let allCustomersData = null;
        let originalCustomersOrder = null; // Store original order
        let lastLoginSortState = 0; // 0 = original, 1 = newest first, 2 = oldest first
        let totalOrdersSortState = 0; // 0 = original, 1 = highest first, 2 = lowest first
        let totalSpentSortState = 0; // 0 = original, 1 = highest first, 2 = lowest first
        let favoritesSortState = 0; // 0 = original, 1 = highest first, 2 = lowest first

        async function loadCustomers() {
            const loadingEl = document.getElementById('customers-loading');
            const errorEl = document.getElementById('customers-error');
            const tableContainer = document.getElementById('customers-table-container');
            const summaryEl = document.getElementById('customers-summary');
            const tbody = document.getElementById('customers-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';
            summaryEl.style.display = 'none';

            try {
                // Get JWT token for authentication
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    alert('You must be logged in to view customer data.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch('/api/admin?endpoint=customers', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to load customers');
                }

                allCustomersData = data.customers;
                
                // Store original order on first load
                if (!originalCustomersOrder) {
                    originalCustomersOrder = [...data.customers];
                }
                
                // Update summary
                document.getElementById('total-customers-count').textContent = data.totalCustomers;
                summaryEl.style.display = 'block';
                
                // Render table
                renderCustomersTable(allCustomersData);
                tableContainer.style.display = 'block';
                document.getElementById('export-customers-btn').style.display = 'inline-block';
                
                // Setup all sortable columns
                setupLastLoginSorting();
                setupTotalOrdersSorting();
                setupTotalSpentSorting();
                setupFavoritesSorting();

            } catch (error) {
                console.error('Error loading customers:', error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customers-tbody');
            
            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="padding: var(--space-md); text-align: center; color: var(--color-text-light);">
                            No customers found
                        </td>
                    </tr>
                `;
                return;
            }

            // Calculate totals across all customers
            const grandTotalOrders = customers.reduce((sum, c) => sum + (c.totalOrders || 0), 0);
            const grandTotalSpent = customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0);
            const grandTotalFavorites = customers.reduce((sum, c) => sum + (c.favorites?.length || 0), 0);

            let html = '';
            customers.forEach((customer, index) => {
                const name = customer.profile?.name || customer.email.split('@')[0];
                // SECURITY: Password removed - never display passwords
                const lastLogin = customer.lastLogin 
                    ? new Date(customer.lastLogin).toLocaleString()
                    : 'Never';
                const lastOrderDate = customer.lastOrderDate 
                    ? new Date(customer.lastOrderDate).toLocaleDateString()
                    : 'Never';
                
                // Get all sizes from profile and orders
                const allSizes = new Set();
                
                // First, check the customer's profile size (their selected size preference)
                if (customer.profile && customer.profile.size) {
                    allSizes.add(customer.profile.size);
                }
                
                // Then, get sizes from all orders
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => allSizes.add(size));
                    } else if (order.cart) {
                        order.cart.forEach(item => {
                            if (item.size) allSizes.add(item.size);
                        });
                    }
                });
                const sizesList = Array.from(allSizes).sort().join(', ') || 'None';
                
                // Get all chapters purchased
                const allChapters = new Set();
                customer.orders.forEach(order => {
                    if (order.chaptersPurchased && Array.isArray(order.chaptersPurchased)) {
                        order.chaptersPurchased.forEach(chapter => allChapters.add(chapter));
                    }
                });
                const chaptersList = Array.from(allChapters).join(', ') || 'None';
                
                // Get unique payment methods
                const paymentMethods = new Set();
                customer.orders.forEach(order => {
                    if (order.paymentMethod) {
                        if (order.paymentMethod.card) {
                            const cardInfo = `${order.paymentMethod.card.brand.toUpperCase()} •••• ${order.paymentMethod.card.last4}`;
                            paymentMethods.add(cardInfo);
                        }
                    }
                });
                const paymentMethodsList = Array.from(paymentMethods).join(', ') || 'None';
                
                // Get address from profile first, then from most recent order
                let customerAddress = 'None';
                if (customer.profile && customer.profile.address) {
                    // Profile address is stored as a single string
                    customerAddress = customer.profile.address;
                } else if (customer.orders && customer.orders.length > 0) {
                    // Fall back to most recent order address
                    const sortedOrders = [...customer.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    const latestOrder = sortedOrders[0];
                    if (latestOrder.shippingAddress) {
                        const addr = latestOrder.shippingAddress;
                        customerAddress = `${addr.street || ''}${addr.apartment ? ', ' + addr.apartment : ''}, ${addr.city || ''} ${addr.postalCode || ''}, ${addr.country || latestOrder.shippingCountry || ''}`.trim();
                        if (customerAddress.endsWith(',')) {
                            customerAddress = customerAddress.slice(0, -1);
                        }
                    } else if (latestOrder.shippingCountry) {
                        customerAddress = latestOrder.shippingCountry;
                    }
                }

                const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                
                html += `
                    <tr ${rowClass} data-email="${customer.email}">
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); position: sticky; left: 0; background: inherit; font-weight: 500;">
                            ${customer.email}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray);">
                            ${name}
                        </td>
                        <!-- SECURITY: Password column removed -->
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${lastLogin}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${customer.totalOrders}
                        </td>
                        <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">
                            €${customer.totalSpent.toFixed(2)}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${lastOrderDate}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${sizesList}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem;">
                            ${chaptersList}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${customer.favorites.length}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; max-width: 200px;">
                            ${customerAddress}
                        </td>
                        <td style="padding: var(--space-sm); border: 1px solid var(--color-gray); font-size: 0.75rem; max-width: 150px;">
                            ${paymentMethodsList || 'None'}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <button class="view-customer-details" data-email="${customer.email}" style="padding: 4px 8px; font-size: 0.75rem; background: var(--color-navy); color: white; border: none; cursor: pointer; border-radius: 2px;">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            // Add total row at the end
            html += `
                <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                    <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">
                        <strong>GRAND TOTAL:</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${customers.length}</strong>
                    </td>
                    <td colspan="2" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${grandTotalOrders}</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">
                        <strong>€${grandTotalSpent.toFixed(2)}</strong>
                    </td>
                    <td colspan="3" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${grandTotalFavorites}</strong>
                    </td>
                    <td style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                    <td colspan="2" style="padding: var(--space-sm); border: 1px solid var(--color-gray);"></td>
                </tr>
            `;
            
            tbody.innerHTML = html;

            // Add click handlers for view details
            document.querySelectorAll('.view-customer-details').forEach(btn => {
                btn.addEventListener('click', () => {
                    const email = btn.dataset.email;
                    showCustomerDetails(email);
                });
            });
            
            // Render size statistics table
            renderSizeStatistics(customers);
        }
        
        function renderSizeStatistics(customers) {
            const sizeStatsContainer = document.getElementById('size-stats-table-container');
            const sizeStatsTbody = document.getElementById('size-stats-tbody');
            const sizeStatsLoading = document.getElementById('size-stats-loading');
            const sizeStatsError = document.getElementById('size-stats-error');
            
            if (!customers || customers.length === 0) {
                sizeStatsContainer.style.display = 'none';
                return;
            }
            
            // Count size selections across all customers
            const sizeCounts = {
                'XS': 0,
                'S': 0,
                'M': 0,
                'L': 0,
                'XL': 0
            };
            
            customers.forEach(customer => {
                const customerSizes = new Set();
                
                // Get sizes from profile
                if (customer.profile && customer.profile.size) {
                    customerSizes.add(customer.profile.size);
                }
                
                // Get sizes from orders
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => customerSizes.add(size));
                    } else if (order.cart) {
                        order.cart.forEach(item => {
                            if (item.size) customerSizes.add(item.size);
                        });
                    }
                });
                
                // Count each size for this customer
                customerSizes.forEach(size => {
                    const normalizedSize = size.toUpperCase();
                    if (sizeCounts.hasOwnProperty(normalizedSize)) {
                        sizeCounts[normalizedSize]++;
                    }
                });
            });
            
            // Render table
            const sizes = ['XS', 'S', 'M', 'L', 'XL'];
            let html = '';
            
            sizes.forEach((size, index) => {
                const count = sizeCounts[size] || 0;
                const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                
                html += `
                    <tr ${rowClass}>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 500;">
                            ${size}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${count}
                        </td>
                    </tr>
                `;
            });
            
            // Add total row
            const totalCustomers = Object.values(sizeCounts).reduce((sum, count) => sum + count, 0);
            html += `
                <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>TOTAL</strong>
                    </td>
                    <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                        <strong>${totalCustomers}</strong>
                    </td>
                </tr>
            `;
            
            sizeStatsTbody.innerHTML = html;
            sizeStatsContainer.style.display = 'block';
            sizeStatsLoading.style.display = 'none';
            sizeStatsError.style.display = 'none';
        }

        function showCustomerDetails(email) {
            const customer = allCustomersData.find(c => c.email === email);
            if (!customer) return;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: var(--space-lg);';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: var(--space-xl); border-radius: 4px; position: relative;';
            
            // Get address from profile first, then from most recent order
            let latestAddress = null;
            if (customer.profile && customer.profile.address) {
                // Profile address is stored as a string, convert to object format for display
                latestAddress = {
                    street: customer.profile.address,
                    city: customer.profile.city || '',
                    postalCode: customer.profile.postalCode || '',
                    country: customer.profile.country || ''
                };
            } else if (customer.orders.length > 0) {
                const sortedOrders = [...customer.orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                latestAddress = sortedOrders[0].shippingAddress;
            }
            
            let ordersHtml = '';
            customer.orders.forEach((order, index) => {
                const orderDate = new Date(order.createdAt).toLocaleString();
                const paymentInfo = order.paymentMethod?.card 
                    ? `${order.paymentMethod.card.brand.toUpperCase()} •••• ${order.paymentMethod.card.last4} (Exp: ${order.paymentMethod.card.exp_month}/${order.paymentMethod.card.exp_year})`
                    : 'N/A';
                
                const address = order.shippingAddress || {};
                const addressStr = address.street 
                    ? `${address.street}${address.apartment ? ', ' + address.apartment : ''}, ${address.city}, ${address.postalCode}, ${address.country || order.shippingCountry || 'N/A'}`
                    : (order.shippingCountry || 'N/A');
                
                ordersHtml += `
                    <div style="border: 1px solid var(--color-gray); padding: var(--space-md); margin-bottom: var(--space-md); border-radius: 4px;">
                        <h4 style="margin-bottom: var(--space-sm);">Order #${order.order_number || order.id}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); font-size: 0.875rem; margin-bottom: var(--space-sm);">
                            <div><strong>Order ID:</strong> ${order.order_id || order.id}</div>
                            <div><strong>User ID:</strong> ${order.user_id || customer.email}</div>
                            <div><strong>Order Number:</strong> ${order.order_number || order.id}</div>
                            <div><strong>Status:</strong> ${order.status}</div>
                            <div><strong>Date:</strong> ${orderDate}</div>
                            <div><strong>Currency:</strong> ${order.currency || 'EUR'}</div>
                            <div><strong>Subtotal:</strong> €${(order.subtotal || 0).toFixed(2)}</div>
                            <div><strong>Shipping Cost:</strong> €${(order.shipping_cost || order.shipping || 0).toFixed(2)}</div>
                            <div><strong>Tax:</strong> €${(order.tax || 0).toFixed(2)}</div>
                            <div><strong>Total:</strong> €${(order.total || 0).toFixed(2)}</div>
                            <div><strong>Payment Method:</strong> ${paymentInfo}</div>
                            <div><strong>Stripe Session:</strong> ${order.stripeSessionId || 'N/A'}</div>
                        </div>
                        <div style="margin-top: var(--space-sm); margin-bottom: var(--space-sm);">
                            <strong>Shipping Address:</strong>
                            <div style="font-size: 0.875rem; margin-top: var(--space-xs); padding: var(--space-xs); background: var(--color-gray-light); border-radius: 2px;">
                                ${address.street || 'N/A'}<br>
                                ${address.apartment ? address.apartment + '<br>' : ''}
                                ${address.city || ''} ${address.postalCode || ''}<br>
                                ${address.country || order.shippingCountry || 'N/A'}
                            </div>
                        </div>
                        <div style="margin-top: var(--space-sm); margin-bottom: var(--space-sm);">
                            <strong>Chapters Purchased:</strong> ${(order.chaptersPurchased || []).join(', ') || 'N/A'}<br>
                            <strong>Sizes Purchased:</strong> ${(order.sizesPurchased || []).join(', ') || 'N/A'}
                        </div>
                        <div style="margin-top: var(--space-sm);">
                            <strong>Items:</strong>
                            <ul style="margin-top: var(--space-xs); padding-left: var(--space-lg);">
                                ${order.cart.map(item => `
                                    <li>${item.name || 'Product'} - ${item.size} / ${item.color} × ${item.quantity} - €${(item.price * item.quantity).toFixed(2)}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            });

            modalContent.innerHTML = `
                <button class="close-modal" style="position: absolute; top: var(--space-md); right: var(--space-md); background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-light);">&times;</button>
                <h2 style="margin-bottom: var(--space-lg);">Customer Details: ${customer.email}</h2>
                
                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Profile Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); font-size: 0.875rem;">
                        <div><strong>Name:</strong> ${customer.profile?.name || 'N/A'}</div>
                        <div><strong>Email:</strong> ${customer.email}</div>
                        <!-- SECURITY: Password removed - never display passwords -->
                        <div><strong>Last Login:</strong> ${customer.lastLogin ? new Date(customer.lastLogin).toLocaleString() : 'Never'}</div>
                        <div><strong>Total Orders:</strong> ${customer.totalOrders}</div>
                        <div><strong>Total Spent:</strong> €${customer.totalSpent.toFixed(2)}</div>
                        <div><strong>Favorites:</strong> ${customer.favorites.length} items</div>
                        <div><strong>Last Updated:</strong> ${customer.updatedAt ? new Date(customer.updatedAt).toLocaleString() : 'N/A'}</div>
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Shipping Address</h3>
                    <div style="font-size: 0.875rem; padding: var(--space-md); background: var(--color-gray-light); border-radius: 4px;">
                        ${latestAddress 
                            ? `${latestAddress.street || 'N/A'}<br>${latestAddress.apartment ? latestAddress.apartment + '<br>' : ''}${latestAddress.city || ''} ${latestAddress.postalCode || ''}<br>${latestAddress.country || 'N/A'}`
                            : 'No address on file'
                        }
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Favorites</h3>
                    <div style="font-size: 0.875rem;">
                        ${customer.favorites.length > 0 
                            ? customer.favorites.map(fav => {
                                // Get product name from ProductsAPI if available
                                let productName = `Product ID: ${fav}`;
                                if (window.ProductsAPI && window.ProductsAPI.getById) {
                                    const product = window.ProductsAPI.getById(fav);
                                    if (product && product.name) {
                                        productName = product.name;
                                    }
                                }
                                return `<span style="display: inline-block; padding: 4px 8px; background: var(--color-gray-light); margin: 4px; border-radius: 2px;">${productName}</span>`;
                            }).join('')
                            : 'No favorites'
                        }
                    </div>
                </div>

                <div style="margin-bottom: var(--space-lg);">
                    <h3 style="margin-bottom: var(--space-sm);">Order History (${customer.orders.length})</h3>
                    ${ordersHtml || '<p>No orders yet</p>'}
                </div>
                
                <div style="margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 2px solid var(--color-gray); text-align: right;">
                    <button class="delete-customer-btn" data-email="${customer.email}" style="padding: var(--space-sm) var(--space-lg); background: #d32f2f; color: white; border: none; cursor: pointer; border-radius: 4px; font-family: var(--font-sans); font-size: 0.875rem; font-weight: 500; letter-spacing: 0.05em;">
                        Delete Customer
                    </button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal handlers
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // Delete customer handler
            const deleteBtn = modal.querySelector('.delete-customer-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    const customerEmail = deleteBtn.dataset.email;
                    const customerName = customer.profile?.name || customerEmail;
                    
                    if (!confirm(`Are you sure you want to delete customer "${customerName}" (${customerEmail})?\n\nThis will permanently delete:\n- All customer data\n- All orders\n- All favorites\n- Profile information\n\nThis action cannot be undone!`)) {
                        return;
                    }
                    
                    // Double confirmation
                    if (!confirm(`FINAL CONFIRMATION: Delete "${customerName}"?\n\nThis action is PERMANENT and CANNOT be undone!`)) {
                        return;
                    }
                    
                    deleteBtn.disabled = true;
                    deleteBtn.textContent = 'Deleting...';
                    
                    try {
                        // Get JWT token for authentication
                        const token = localStorage.getItem('sandroSandri_session_token');
                        if (!token) {
                            alert('You must be logged in to delete customers.');
                            return;
                        }

                        const response = await fetch(`/api/admin?endpoint=customers&email=${encodeURIComponent(customerEmail)}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'X-Session-Token': token
                            },
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            alert(`Customer "${customerName}" has been deleted successfully.`);
                            document.body.removeChild(modal);
                            // Reload customers table
                            loadCustomers();
                        } else {
                            throw new Error(data.error || 'Failed to delete customer');
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        alert(`Error deleting customer: ${error.message}`);
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'Delete Customer';
                    }
                });
            }
        }

        function exportToCSV() {
            if (!allCustomersData) {
                alert('Please load customers first');
                return;
            }

            // Create CSV content
            // SECURITY: Password removed from CSV export
            let csv = 'Email,Name,Last Login,Total Orders,Total Spent,Last Order Date,Sizes Purchased,Chapters Purchased,Favorites Count,Payment Methods\n';
            
            allCustomersData.forEach(customer => {
                const name = customer.profile?.name || customer.email.split('@')[0];
                // SECURITY: Password removed from CSV export
                const lastLogin = customer.lastLogin ? new Date(customer.lastLogin).toLocaleString() : 'Never';
                const lastOrderDate = customer.lastOrderDate || 'Never';
                
                // Get all sizes
                const allSizes = new Set();
                customer.orders.forEach(order => {
                    if (order.sizesPurchased && Array.isArray(order.sizesPurchased)) {
                        order.sizesPurchased.forEach(size => allSizes.add(size));
                    }
                });
                const sizesStr = Array.from(allSizes).sort().join('; ') || 'None';
                
                // Get all chapters
                const allChapters = new Set();
                customer.orders.forEach(order => {
                    if (order.chaptersPurchased && Array.isArray(order.chaptersPurchased)) {
                        order.chaptersPurchased.forEach(chapter => allChapters.add(chapter));
                    }
                });
                const chaptersStr = Array.from(allChapters).join('; ') || 'None';
                
                const paymentMethods = new Set();
                customer.orders.forEach(order => {
                    if (order.paymentMethod?.card) {
                        paymentMethods.add(`${order.paymentMethod.card.brand} •••• ${order.paymentMethod.card.last4}`);
                    }
                });
                const paymentMethodsStr = Array.from(paymentMethods).join('; ') || 'None';
                
                // SECURITY: Password removed from CSV export
                csv += `"${customer.email}","${name}","${lastLogin}",${customer.totalOrders},${customer.totalSpent.toFixed(2)},"${lastOrderDate}","${sizesStr}","${chaptersStr}",${customer.favorites.length},"${paymentMethodsStr}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Bind buttons
        document.getElementById('load-customers-btn').addEventListener('click', loadCustomers);
        document.getElementById('export-customers-btn').addEventListener('click', exportToCSV);

        // Last Login Column Sorting
        function setupLastLoginSorting() {
            const header = document.getElementById('last-login-header');
            const indicator = document.getElementById('last-login-sort-indicator');
            
            if (!header) return;
            
            // Remove existing listener if any
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            // Add click listener
            document.getElementById('last-login-header').addEventListener('click', () => {
                if (!allCustomersData || allCustomersData.length === 0) return;
                
                // Reset other sort states
                totalOrdersSortState = 0;
                totalSpentSortState = 0;
                favoritesSortState = 0;
                resetSortIndicators(['total-orders', 'total-spent', 'favorites']);
                
                // Cycle through sort states: 0 -> 1 -> 2 -> 0
                lastLoginSortState = (lastLoginSortState + 1) % 3;
                
                let sortedCustomers;
                
                if (lastLoginSortState === 0) {
                    // Original order
                    sortedCustomers = originalCustomersOrder ? [...originalCustomersOrder] : [...allCustomersData];
                    indicator.textContent = '↕';
                    indicator.style.color = '';
                } else if (lastLoginSortState === 1) {
                    // Newest first (most recent login first)
                    sortedCustomers = [...allCustomersData].sort((a, b) => {
                        const dateA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                        const dateB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                        return dateB - dateA; // Descending (newest first)
                    });
                    indicator.textContent = '↓';
                    indicator.style.color = 'var(--color-navy)';
                } else {
                    // Oldest first (least recent login first)
                    sortedCustomers = [...allCustomersData].sort((a, b) => {
                        const dateA = a.lastLogin ? new Date(a.lastLogin).getTime() : 0;
                        const dateB = b.lastLogin ? new Date(b.lastLogin).getTime() : 0;
                        // Put "Never" (0) at the end
                        if (dateA === 0 && dateB === 0) return 0;
                        if (dateA === 0) return 1;
                        if (dateB === 0) return -1;
                        return dateA - dateB; // Ascending (oldest first)
                    });
                    indicator.textContent = '↑';
                    indicator.style.color = 'var(--color-navy)';
                }
                
                // Re-render table with sorted data
                renderCustomersTable(sortedCustomers);
            });
        }

        // Total Orders Column Sorting
        function setupTotalOrdersSorting() {
            const header = document.getElementById('total-orders-header');
            const indicator = document.getElementById('total-orders-sort-indicator');
            
            if (!header) return;
            
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            document.getElementById('total-orders-header').addEventListener('click', () => {
                if (!allCustomersData || allCustomersData.length === 0) return;
                
                // Reset other sort states
                lastLoginSortState = 0;
                totalSpentSortState = 0;
                favoritesSortState = 0;
                resetSortIndicators(['last-login', 'total-spent', 'favorites']);
                
                totalOrdersSortState = (totalOrdersSortState + 1) % 3;
                
                let sortedCustomers;
                
                if (totalOrdersSortState === 0) {
                    sortedCustomers = originalCustomersOrder ? [...originalCustomersOrder] : [...allCustomersData];
                    indicator.textContent = '↕';
                    indicator.style.color = '';
                } else if (totalOrdersSortState === 1) {
                    // Highest first
                    sortedCustomers = [...allCustomersData].sort((a, b) => (b.totalOrders || 0) - (a.totalOrders || 0));
                    indicator.textContent = '↓';
                    indicator.style.color = 'var(--color-navy)';
                } else {
                    // Lowest first
                    sortedCustomers = [...allCustomersData].sort((a, b) => (a.totalOrders || 0) - (b.totalOrders || 0));
                    indicator.textContent = '↑';
                    indicator.style.color = 'var(--color-navy)';
                }
                
                renderCustomersTable(sortedCustomers);
            });
        }

        // Total Spent Column Sorting
        function setupTotalSpentSorting() {
            const header = document.getElementById('total-spent-header');
            const indicator = document.getElementById('total-spent-sort-indicator');
            
            if (!header) return;
            
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            document.getElementById('total-spent-header').addEventListener('click', () => {
                if (!allCustomersData || allCustomersData.length === 0) return;
                
                // Reset other sort states
                lastLoginSortState = 0;
                totalOrdersSortState = 0;
                favoritesSortState = 0;
                resetSortIndicators(['last-login', 'total-orders', 'favorites']);
                
                totalSpentSortState = (totalSpentSortState + 1) % 3;
                
                let sortedCustomers;
                
                if (totalSpentSortState === 0) {
                    sortedCustomers = originalCustomersOrder ? [...originalCustomersOrder] : [...allCustomersData];
                    indicator.textContent = '↕';
                    indicator.style.color = '';
                } else if (totalSpentSortState === 1) {
                    // Highest first
                    sortedCustomers = [...allCustomersData].sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0));
                    indicator.textContent = '↓';
                    indicator.style.color = 'var(--color-navy)';
                } else {
                    // Lowest first
                    sortedCustomers = [...allCustomersData].sort((a, b) => (a.totalSpent || 0) - (b.totalSpent || 0));
                    indicator.textContent = '↑';
                    indicator.style.color = 'var(--color-navy)';
                }
                
                renderCustomersTable(sortedCustomers);
            });
        }

        // Favorites Column Sorting
        function setupFavoritesSorting() {
            const header = document.getElementById('favorites-header');
            const indicator = document.getElementById('favorites-sort-indicator');
            
            if (!header) return;
            
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            document.getElementById('favorites-header').addEventListener('click', () => {
                if (!allCustomersData || allCustomersData.length === 0) return;
                
                // Reset other sort states
                lastLoginSortState = 0;
                totalOrdersSortState = 0;
                totalSpentSortState = 0;
                resetSortIndicators(['last-login', 'total-orders', 'total-spent']);
                
                favoritesSortState = (favoritesSortState + 1) % 3;
                
                let sortedCustomers;
                
                if (favoritesSortState === 0) {
                    sortedCustomers = originalCustomersOrder ? [...originalCustomersOrder] : [...allCustomersData];
                    indicator.textContent = '↕';
                    indicator.style.color = '';
                } else if (favoritesSortState === 1) {
                    // Highest first
                    sortedCustomers = [...allCustomersData].sort((a, b) => (b.favorites?.length || 0) - (a.favorites?.length || 0));
                    indicator.textContent = '↓';
                    indicator.style.color = 'var(--color-navy)';
                } else {
                    // Lowest first
                    sortedCustomers = [...allCustomersData].sort((a, b) => (a.favorites?.length || 0) - (b.favorites?.length || 0));
                    indicator.textContent = '↑';
                    indicator.style.color = 'var(--color-navy)';
                }
                
                renderCustomersTable(sortedCustomers);
            });
        }

        // Helper function to reset sort indicators
        function resetSortIndicators(columnIds) {
            columnIds.forEach(colId => {
                const indicator = document.getElementById(`${colId}-sort-indicator`);
                if (indicator) {
                    indicator.textContent = '↕';
                    indicator.style.color = '';
                }
            });
        }

        // Stock Table Management
        async function loadStock() {
            const loadingEl = document.getElementById('stock-loading');
            const errorEl = document.getElementById('stock-error');
            const tableContainer = document.getElementById('stock-table-container');
            const tbody = document.getElementById('stock-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';

            try {
                // Fetch current inventory
                const inventoryResponse = await fetch('/api/inventory/stock');

                if (!inventoryResponse.ok) {
                    throw new Error('Failed to load inventory');
                }

                const inventoryData = await inventoryResponse.json();
                console.log('📦 Inventory data received:', inventoryData);

                // Get products from window.ProductsAPI
                const products = window.ProductsAPI ? window.ProductsAPI.getAll() : [];
                const tshirtProducts = products.filter(p => p.category === 'tshirts');
                console.log('📦 T-shirt products found:', tshirtProducts.length, tshirtProducts.map(p => ({ id: p.id, name: p.name })));

                // Get stock levels for each product
                const stockData = tshirtProducts.map(product => {
                    const productInventory = inventoryData.find(inv => inv.productId === product.id);
                    console.log(`📦 Product ${product.id} (${product.name}):`, productInventory);
                    
                    const stock = {
                        XS: 0,
                        S: 0,
                        M: 0,
                        L: 0,
                        XL: 0
                    };

                    // Get stock from inventory API response
                    if (productInventory && productInventory.sizes) {
                        productInventory.sizes.forEach(sizeInfo => {
                            if (stock.hasOwnProperty(sizeInfo.size)) {
                                stock[sizeInfo.size] = sizeInfo.stock || 0;
                            }
                        });
                    } else {
                        console.warn(`⚠️ Product ${product.id} (${product.name}) has no inventory data!`);
                    }

                    // Calculate total stock
                    const totalStock = stock.XS + stock.S + stock.M + stock.L + stock.XL;

                    return {
                        productId: product.id,
                        name: product.name,
                        stock: stock,
                        totalStock: totalStock
                    };
                });

                // Render table
                let html = '';
                let grandTotalXS = 0, grandTotalS = 0, grandTotalM = 0, grandTotalL = 0, grandTotalXL = 0, grandTotalAll = 0;

                stockData.forEach((item, index) => {
                    grandTotalXS += item.stock.XS;
                    grandTotalS += item.stock.S;
                    grandTotalM += item.stock.M;
                    grandTotalL += item.stock.L;
                    grandTotalXL += item.stock.XL;
                    grandTotalAll += item.totalStock;

                    const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';
                    
                    // Highlight low stock (less than 5) in red
                    const xsStyle = item.stock.XS < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const sStyle = item.stock.S < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const mStyle = item.stock.M < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const lStyle = item.stock.L < 5 ? 'color: #c00; font-weight: 600;' : '';
                    const xlStyle = item.stock.XL < 5 ? 'color: #c00; font-weight: 600;' : '';
                    
                    html += `
                        <tr ${rowClass}>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); position: sticky; left: 0; background: inherit; font-weight: 500;">
                                ${item.name}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${xsStyle}">
                                ${item.stock.XS}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${sStyle}">
                                ${item.stock.S}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${mStyle}">
                                ${item.stock.M}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${lStyle}">
                                ${item.stock.L}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); ${xlStyle}">
                                ${item.stock.XL}
                            </td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); font-weight: 600;">
                                ${item.totalStock}
                            </td>
                        </tr>
                    `;
                });

                // Add total row
                html += `
                    <tr style="background: var(--color-navy); color: white; font-weight: 600;">
                        <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">
                            <strong>TOTAL:</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalXS}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalS}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalM}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalL}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalXL}</strong>
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <strong>${grandTotalAll}</strong>
                        </td>
                    </tr>
                `;

                tbody.innerHTML = html;
                tableContainer.style.display = 'block';

            } catch (error) {
                console.error('Error loading stock:', error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        document.getElementById('load-stock-btn').addEventListener('click', loadStock);

        // Chapter Modes Management
        async function loadChapterModes() {
            const loadingEl = document.getElementById('chapter-modes-loading');
            const errorEl = document.getElementById('chapter-modes-error');
            const tableContainer = document.getElementById('chapter-modes-table-container');
            const tbody = document.getElementById('chapter-modes-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';

            try {
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch('/api/site-settings?setting=chapter-modes', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load chapter modes');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load chapter modes');
                }

                const chapterModes = data.chapter_modes || {};
                renderChapterModesTable(chapterModes);
                tableContainer.style.display = 'block';

            } catch (error) {
                console.error('Error loading chapter modes:', error);
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        function renderChapterModesTable(chapterModes) {
            const tbody = document.getElementById('chapter-modes-tbody');
            const chapters = [
                { key: 'chapter_i', label: 'Chapter I' },
                { key: 'chapter_ii', label: 'Chapter II' },
                { key: 'chapter_iii', label: 'Chapter III' },
                { key: 'chapter_iv', label: 'Chapter IV' },
                { key: 'chapter_v', label: 'Chapter V' },
                { key: 'chapter_vi', label: 'Chapter VI' },
                { key: 'chapter_vii', label: 'Chapter VII' },
                { key: 'chapter_viii', label: 'Chapter VIII' },
                { key: 'chapter_ix', label: 'Chapter IX' },
                { key: 'chapter_x', label: 'Chapter X' }
            ];

            let html = '';
            chapters.forEach((chapter, index) => {
                const chapterData = chapterModes[chapter.key] || { created: false, mode: 'LIVE' };
                const isCreated = chapterData.created === true;
                const currentMode = chapterData.mode || 'LIVE';
                const rowClass = index % 2 === 0 ? 'style="background: var(--color-white);"' : 'style="background: var(--color-gray-light);"';

                html += `
                    <tr ${rowClass}>
                        <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); font-weight: 500; position: sticky; left: 0; background: inherit;">
                            ${chapter.label}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${isCreated ? `
                                <button class="chapter-mode-btn ${currentMode === 'WAITLIST' ? 'active' : ''}" 
                                        data-chapter="${chapter.key}" 
                                        data-mode="WAITLIST"
                                        style="padding: var(--space-xs) var(--space-sm); font-family: var(--font-sans); font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 2px; cursor: pointer; background: ${currentMode === 'WAITLIST' ? '#4caf50' : '#000'}; color: white; min-width: 40px;">
                                    ${currentMode === 'WAITLIST' ? '✓' : ''}
                                </button>
                            ` : '-'}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${isCreated ? `
                                <button class="chapter-mode-btn ${currentMode === 'EARLY_ACCESS' ? 'active' : ''}" 
                                        data-chapter="${chapter.key}" 
                                        data-mode="EARLY_ACCESS"
                                        style="padding: var(--space-xs) var(--space-sm); font-family: var(--font-sans); font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 2px; cursor: pointer; background: ${currentMode === 'EARLY_ACCESS' ? '#4caf50' : '#000'}; color: white; min-width: 40px;">
                                    ${currentMode === 'EARLY_ACCESS' ? '✓' : ''}
                                </button>
                            ` : '-'}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            ${isCreated ? `
                                <button class="chapter-mode-btn ${currentMode === 'LIVE' ? 'active' : ''}" 
                                        data-chapter="${chapter.key}" 
                                        data-mode="LIVE"
                                        style="padding: var(--space-xs) var(--space-sm); font-family: var(--font-sans); font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 2px; cursor: pointer; background: ${currentMode === 'LIVE' ? '#4caf50' : '#000'}; color: white; min-width: 40px;">
                                    ${currentMode === 'LIVE' ? '✓' : ''}
                                </button>
                            ` : '-'}
                        </td>
                        <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                            <button class="chapter-created-btn ${isCreated ? 'active' : ''}" 
                                    data-chapter="${chapter.key}"
                                    style="padding: var(--space-xs) var(--space-sm); font-family: var(--font-sans); font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 2px; cursor: pointer; background: ${isCreated ? '#4caf50' : '#000'}; color: white; min-width: 50px;">
                                ${isCreated ? 'Sim' : 'Não'}
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Bind event listeners
            bindChapterModeButtons();
        }

        function bindChapterModeButtons() {
            // Created buttons
            document.querySelectorAll('.chapter-created-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const chapter = btn.dataset.chapter;
                    const isCurrentlyCreated = btn.textContent.trim() === 'Sim';
                    const newCreatedState = !isCurrentlyCreated;

                    await setChapterCreated(chapter, newCreatedState);
                    await loadChapterModes(); // Reload table
                });
            });

            // Mode buttons (only work if chapter is created)
            document.querySelectorAll('.chapter-mode-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const chapter = btn.dataset.chapter;
                    const mode = btn.dataset.mode;

                    await setChapterMode(chapter, mode);
                    await loadChapterModes(); // Reload table
                });
            });
        }

        async function setChapterCreated(chapter, created) {
            try {
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch('/api/site-settings?setting=chapter-modes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    },
                    body: JSON.stringify({
                        chapter: chapter,
                        created: created
                    })
                });

                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to update chapter created status');
                }

                const messageEl = document.getElementById('chapter-message');
                messageEl.textContent = `Chapter ${chapter} ${created ? 'marked as created' : 'marked as not created'}`;
                messageEl.style.display = 'block';
                messageEl.style.background = '#e8f5e9';
                messageEl.style.color = '#2e7d32';
                messageEl.style.border = '1px solid #4caf50';
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Error setting chapter created:', error);
                const messageEl = document.getElementById('chapter-message');
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.style.display = 'block';
                messageEl.style.background = '#ffebee';
                messageEl.style.color = '#c62828';
                messageEl.style.border = '1px solid #ef5350';
            }
        }

        async function setChapterMode(chapter, mode) {
            try {
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch('/api/site-settings?setting=chapter-modes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    },
                    body: JSON.stringify({
                        chapter: chapter,
                        mode: mode
                    })
                });

                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to update chapter mode');
                }

                const messageEl = document.getElementById('chapter-message');
                messageEl.textContent = `${chapter} mode set to ${mode}`;
                messageEl.style.display = 'block';
                messageEl.style.background = '#e8f5e9';
                messageEl.style.color = '#2e7d32';
                messageEl.style.border = '1px solid #4caf50';
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Error setting chapter mode:', error);
                const messageEl = document.getElementById('chapter-message');
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.style.display = 'block';
                messageEl.style.background = '#ffebee';
                messageEl.style.color = '#c62828';
                messageEl.style.border = '1px solid #ef5350';
            }
        }

        // Load chapter modes on page load
        loadChapterModes();

        // Chapter Management (Legacy - keeping for backward compatibility)
        async function loadActiveChapter() {
            try {
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    document.getElementById('active-chapter-status').textContent = 'Not authenticated';
                    return;
                }

                const response = await fetch('/api/site-settings?setting=active-chapter', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load active chapter');
                }

                const data = await response.json();
                if (data.success) {
                    const chapter = data.activeChapter === 'chapter_ii' ? 'Chapter II' : 'Chapter I';
                    document.getElementById('active-chapter-status').textContent = `Current: ${chapter}`;
                }
            } catch (error) {
                console.error('Error loading active chapter:', error);
                document.getElementById('active-chapter-status').textContent = 'Error loading status';
            }
        }

        async function setActiveChapter(chapter) {
            const messageEl = document.getElementById('chapter-message');
            messageEl.style.display = 'none';

            try {
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch('/api/site-settings?setting=active-chapter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    },
                    body: JSON.stringify({ active_chapter: chapter })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update active chapter');
                }

                const data = await response.json();
                if (data.success) {
                    messageEl.textContent = data.message || 'Chapter updated successfully';
                    messageEl.style.display = 'block';
                    messageEl.style.background = '#e8f5e9';
                    messageEl.style.color = '#2e7d32';
                    messageEl.style.border = '1px solid #4caf50';
                    
                    // Update status
                    await loadActiveChapter();
                    
                    // Show success message for 3 seconds
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error setting active chapter:', error);
                messageEl.textContent = error.message || 'Failed to update active chapter';
                messageEl.style.display = 'block';
                messageEl.style.background = '#ffebee';
                messageEl.style.color = '#c62828';
                messageEl.style.border = '1px solid #ef5350';
            }
        }

        // Legacy chapter buttons (keeping for backward compatibility)
        const setChapterIBtn = document.getElementById('set-chapter-i-btn');
        const setChapterIIBtn = document.getElementById('set-chapter-ii-btn');
        
        if (setChapterIBtn) {
            setChapterIBtn.addEventListener('click', () => {
                setActiveChapter('chapter_i');
            });
        }
        
        if (setChapterIIBtn) {
            setChapterIIBtn.addEventListener('click', () => {
                setActiveChapter('chapter_ii');
            });
        }

        // Load active chapter on page load
        loadActiveChapter();

        // Orders Management
        async function loadOrders() {
            const loadingEl = document.getElementById('orders-loading');
            const errorEl = document.getElementById('orders-error');
            const tableContainer = document.getElementById('orders-table-container');
            const summaryEl = document.getElementById('orders-summary');
            const tbody = document.getElementById('orders-tbody');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            tableContainer.style.display = 'none';
            summaryEl.style.display = 'none';

            try {
                // Get JWT token
                const token = localStorage.getItem('sandroSandri_session_token');
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch('/api/admin/orders', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-Session-Token': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load orders');
                }

                const orders = data.orders || [];
                
                // Update summary
                document.getElementById('total-orders-count').textContent = orders.length;
                summaryEl.style.display = 'block';

                // Build table
                tbody.innerHTML = '';
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: var(--space-lg); color: var(--color-text-light);">No orders found</td></tr>';
                } else {
                    orders.forEach(order => {
                        const address = order.shippingAddress || {};
                        const confirmationStatus = order.confirmationStatus || 'Nothing';
                        const orderStatus = order.orderStatus || order.status || 'PAID';
                        const trackingNumber = order.trackingNumber || '';
                        
                        // Format items purchased
                        const itemsPurchased = (order.cart || []).map(item => {
                            return `${item.quantity}x ${item.size || 'N/A'} - Model ${item.productId || 'N/A'}`;
                        }).join(', ') || 'N/A';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray); position: sticky; left: 0; background: white; z-index: 5;">
                                <select class="confirmation-status-select" data-order-id="${order.id}" style="padding: 4px 8px; font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 4px;">
                                    <option value="Nothing" ${confirmationStatus === 'Nothing' ? 'selected' : ''}>Nothing</option>
                                    <option value="Packed" ${confirmationStatus === 'Packed' ? 'selected' : ''}>Packed</option>
                                    <option value="Sent" ${confirmationStatus === 'Sent' ? 'selected' : ''}>Sent</option>
                                    <option value="Delivered" ${confirmationStatus === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                </select>
                            </td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${order.orderNumber || order.id || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${order.name || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${order.email || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${order.phoneNumber || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${address.street || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${address.apartment || '-'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${address.city || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${address.postalCode || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">${address.country || address.countryName || 'N/A'}</td>
                            <td style="padding: var(--space-sm); text-align: right; border: 1px solid var(--color-gray);">€${(order.total || 0).toFixed(2)}</td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray); max-width: 200px; word-wrap: break-word;">${itemsPurchased}</td>
                            <td style="padding: var(--space-sm); text-align: center; border: 1px solid var(--color-gray);">
                                <select class="order-status-select" data-order-id="${order.id}" style="padding: 4px 8px; font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 4px;">
                                    <option value="PAID" ${orderStatus === 'PAID' ? 'selected' : ''}>Paid</option>
                                    <option value="PROCESSING" ${orderStatus === 'PROCESSING' ? 'selected' : ''}>Processing</option>
                                    <option value="SHIPPED" ${orderStatus === 'SHIPPED' ? 'selected' : ''}>Shipped</option>
                                    <option value="DELIVERED" ${orderStatus === 'DELIVERED' ? 'selected' : ''}>Delivered</option>
                                </select>
                            </td>
                            <td style="padding: var(--space-sm); text-align: left; border: 1px solid var(--color-gray);">
                                <input type="text" class="tracking-number-input" data-order-id="${order.id}" value="${trackingNumber}" placeholder="Enter tracking number" style="padding: 4px 8px; font-size: 0.75rem; border: 1px solid var(--color-gray); border-radius: 4px; width: 150px;">
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // Add event listeners for confirmation status changes
                document.querySelectorAll('.confirmation-status-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const orderId = e.target.dataset.orderId;
                        const confirmationStatus = e.target.value;
                        
                        try {
                            const token = localStorage.getItem('sandroSandri_session_token');
                            const response = await fetch('/api/admin/orders', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                    'X-Session-Token': token
                                },
                                body: JSON.stringify({
                                    orderId: orderId,
                                    confirmationStatus: confirmationStatus
                                })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.success) {
                                    console.log('Order confirmation status updated');
                                }
                            }
                        } catch (error) {
                            console.error('Error updating confirmation status:', error);
                            alert('Error updating confirmation status');
                        }
                    });
                });

                // Add event listeners for order status changes
                document.querySelectorAll('.order-status-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const orderId = e.target.dataset.orderId;
                        const orderStatus = e.target.value;
                        
                        try {
                            const token = localStorage.getItem('sandroSandri_session_token');
                            const response = await fetch('/api/admin/orders', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                    'X-Session-Token': token
                                },
                                body: JSON.stringify({
                                    orderId: orderId,
                                    orderStatus: orderStatus
                                })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.success) {
                                    console.log('Order status updated');
                                    // If status is SHIPPED and tracking number exists, email will be sent automatically
                                }
                            }
                        } catch (error) {
                            console.error('Error updating order status:', error);
                            alert('Error updating order status');
                        }
                    });
                });

                // Add event listeners for tracking number changes
                document.querySelectorAll('.tracking-number-input').forEach(input => {
                    let timeout;
                    input.addEventListener('input', (e) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(async () => {
                            const orderId = e.target.dataset.orderId;
                            const trackingNumber = e.target.value.trim();
                            
                            try {
                                const token = localStorage.getItem('sandroSandri_session_token');
                                const response = await fetch('/api/admin/orders', {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`,
                                        'X-Session-Token': token
                                    },
                                    body: JSON.stringify({
                                        orderId: orderId,
                                        trackingNumber: trackingNumber
                                    })
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.success) {
                                        console.log('Tracking number updated');
                                        // If tracking number is added and status is SHIPPED, email will be sent automatically
                                        if (trackingNumber) {
                                            // Also update order status to SHIPPED if not already
                                            const orderStatusSelect = document.querySelector(`.order-status-select[data-order-id="${orderId}"]`);
                                            if (orderStatusSelect && orderStatusSelect.value !== 'SHIPPED') {
                                                orderStatusSelect.value = 'SHIPPED';
                                                orderStatusSelect.dispatchEvent(new Event('change'));
                                            }
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('Error updating tracking number:', error);
                                alert('Error updating tracking number');
                            }
                        }, 1000); // Debounce 1 second
                    });
                });

                loadingEl.style.display = 'none';
                tableContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading orders:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Error loading orders: ' + error.message;
                errorEl.style.display = 'block';
            }
        }

        document.getElementById('load-orders-btn').addEventListener('click', loadOrders);
    </script>
</body>
</html>

